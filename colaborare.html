<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard Bucătari – Profesional</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer"/>
  <style>
    :root{
      --verde:#0e5a43; --verde-2:#0b4a36; --text:#1c2226; --g1:#f6fbf8; --g2:#eef3ff; --b1:#fff; --b2:#e8ecee; --b3:#cfd6da; --warn:#fff3cd; --warn-text:#856404; --shadow:0 14px 46px rgba(0,0,0,.12);
    }
    *{box-sizing:border-box}
    html,body{margin:0}
    body{font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:var(--text);
      background:radial-gradient(1200px 600px at -10% -10%,var(--g2),#fff 40%),radial-gradient(900px 500px at 110% -20%,var(--g1),#fff 40%);
      min-height:100vh;
    }
    .container{width:min(1180px,94%);margin:auto;padding-bottom:48px}
    /* Tabs */
    .tabs{position:sticky;top:0;background:#ffffffc9;border-bottom:1px solid var(--b2);backdrop-filter:saturate(140%) blur(6px);
      z-index:10;display:flex;gap:10px;padding:12px 0;flex-wrap:wrap}
    .tab{padding:10px 14px;border:1px solid var(--b3);border-radius:999px;font-weight:700;background:#fff;cursor:pointer;user-select:none}
    .tab.active{border-color:var(--verde);color:var(--verde);box-shadow:0 6px 18px rgba(14,90,67,.18)}
    /* Cards */
    .card{background:#fff;border:1px solid var(--b2);border-radius:18px;padding:20px;box-shadow:var(--shadow);margin-top:18px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    @media(max-width:900px){.grid{grid-template-columns:1fr}}
    label{font-size:14px;font-weight:700;display:block;margin-bottom:6px}
    input,textarea,select{width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--b3);background:#fbfcfc}
    textarea{min-height:90px}
    .note{font-size:13px;color:#5c6a6f}
    .warn{background:var(--warn);color:var(--warn-text);padding:10px 12px;border-radius:10px;font-weight:700;display:flex;gap:8px;align-items:center;margin:10px 0}
    /* Chat */
    .req-layout{display:grid;grid-template-columns:0.42fr 1fr;gap:16px}
    @media(max-width:900px){.req-layout{grid-template-columns:1fr}}
    .req-list{border:1px solid var(--b2);border-radius:12px;overflow:hidden;background:#fff}
    .req-item{padding:12px;border-bottom:1px solid var(--b2);cursor:pointer;display:flex;justify-content:space-between}
    .req-item.active{background:#f6fbf8;border-left:4px solid var(--verde)}
    .badge{font-size:12px;padding:4px 8px;border-radius:999px}
    .badge.pending{background:#fff7e6;color:#8a5b00}
    .badge.accepted{background:#eaf5ef;color:var(--verde-2)}
    .badge.closed{background:#eceff3;color:#555}
    .chat{border:1px solid var(--b2);border-radius:14px;display:flex;flex-direction:column;height:420px;background:#fff}
    .chat-messages{flex:1;overflow:auto;padding:12px;display:flex;flex-direction:column;gap:10px;background:#fafdfb}
    .msg{max-width:75%;padding:10px 12px;border-radius:12px}
    .msg.me{align-self:flex-end;background:var(--verde);color:#fff}
    .msg.them{align-self:flex-start;background:#eef5f1}
    .chat-input{display:flex;gap:8px;padding:10px;border-top:1px solid var(--b2)}
    .chat-input input{flex:1}
    /* Tables */
    .table{width:100%;border-collapse:separate;border-spacing:0 8px}
    .table th{background:var(--verde);color:#fff;text-align:left;padding:10px;border-radius:8px}
    .table td{background:#f6fbf8;padding:8px;border:1px solid #d1ded6}
    /* Financiar */
    .wallet{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:16px}
    .stat{border:1px solid var(--b2);border-radius:14px;padding:16px;background:linear-gradient(135deg,#f2faf5,#fff)}
    .stat strong{font-size:20px}
    /* Profile portrait */
    .portrait{display:flex;gap:16px;align-items:flex-start;flex-wrap:wrap}
    .portrait img{width:300px;height:300px;object-fit:cover;border-radius:10px;border:3px solid var(--verde);background:#ddd}
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.7);color:#fff;display:none;align-items:center;justify-content:center;text-align:center;padding:20px;font-size:18px;z-index:999}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:999px;border:1px solid var(--b3);background:#fff;font-weight:700;cursor:pointer}
    .btn.primary{background:var(--verde);border-color:transparent;color:#fff}
    /* Progress */
    .progress-card{display:flex;flex-direction:column;gap:8px}
    .progress-rail{height:12px;background:#eef3ef;border-radius:999px;overflow:hidden}
    .progress-bar{height:100%;width:0;background:linear-gradient(90deg,var(--verde),#23a576);transition:width .35s ease;border-radius:999px}
    .progress-head{display:flex;justify-content:space-between;align-items:center}

    /* ==== Stiluri pentru noua secțiune Documente (colaborare) ==== */
    .collab-wrap .container-slim{max-width:1000px;margin:0 auto}
    .collab-note{background:#fff3cd;padding:12px;border-radius:8px;font-size:14px;margin-bottom:16px}
    .collab-options{display:flex;gap:20px;margin-bottom:20px;flex-wrap:wrap}
    .collab-option{flex:1;min-width:260px;border:2px solid #ddd;border-radius:10px;padding:16px;cursor:pointer;transition:all .3s;background:#fff}
    .collab-option:hover{border-color:var(--verde);background:#f9fffb}
    .collab-option.active{border-color:var(--verde);background:#e6f4ef}
    .collab-option h3{margin-top:0;font-size:16px;color:var(--verde)}
    .collab-option ul{padding-left:18px;font-size:14px;margin:8px 0 0}
    .calc{border-top:1px solid #eee;padding-top:16px;margin-top:6px}
    .row{display:flex;gap:16px;margin-bottom:10px;align-items:center}
    .row label{flex:1}
    .row input,.row select{flex:2;padding:8px;border:1px solid #ccc;border-radius:8px}
    .result{margin-top:8px;font-weight:600;font-size:15px}
    .btn-save{padding:10px 16px;border-radius:8px;border:1px solid var(--verde);background:var(--verde);color:#fff;font-weight:600}
    .btn-outline{padding:10px 16px;border-radius:8px;border:1px solid var(--verde);background:#fff;color:var(--verde);font-weight:600}
  </style>
</head>
<body>
<div class="container">
  <!-- Tabs -->
  <nav class="tabs" id="tabs" role="tablist" aria-label="Secțiuni dashboard">
    <span class="tab active" data-tab="profil" role="tab" aria-selected="true" tabindex="0">Profil</span>
    <span class="tab" data-tab="documente" role="tab" aria-selected="false" tabindex="0">Documente</span>
    <span class="tab" data-tab="galerie" role="tab" aria-selected="false" tabindex="0">Galerie</span>
    <span class="tab" data-tab="meniuri" role="tab" aria-selected="false" tabindex="0">Meniuri</span>
    <span class="tab" data-tab="cereri" role="tab" aria-selected="false" tabindex="0">Cereri</span>
    <span class="tab" data-tab="financiar" role="tab" aria-selected="false" tabindex="0">Financiar</span>
  </nav>

  <!-- Progress overall -->
  <section class="card progress-card" id="progress" aria-labelledby="progressTitle">
    <div class="progress-head">
      <strong id="progressTitle">Progres profil</strong>
      <span id="progress-label">0%</span>
    </div>
    <div class="progress-rail" aria-hidden="true"><div id="progress-bar" class="progress-bar"></div></div>
    <div id="progress-tips" class="note" aria-live="polite">Completează pașii pentru activare completă.</div>
  </section>

  <!-- PROFIL -->
  <section class="card section" id="profil">
    <h2>Profil – Portret obligatoriu</h2>
    <div class="warn"><i class="fa-solid fa-triangle-exclamation"></i> Poza trebuie să fie pătrată (min. 600×600px), <b>în tunica oficială Bucătarul Personal</b>. Se aplică automat un watermark transparent.</div>
    <div class="portrait">
      <img id="portraitPreview" loading="lazy" src="https://via.placeholder.com/300x300.png?text=Portret" alt="Portret" onerror="this.src='https://via.placeholder.com/300x300.png?text=Portret'" />
      <div>
        <div id="quality" class="note" aria-live="polite"></div>
        <label for="portraitUpload">Încarcă portret (PNG/JPG)</label>
        <input type="file" id="portraitUpload" accept="image/jpeg,image/png"/>
        <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap">
          <button id="cameraBtn" type="button" class="btn primary"><i class="fa-solid fa-camera"></i> Fă poză</button>
          <button id="removePortrait" type="button" class="btn"><i class="fa-solid fa-trash"></i> Șterge</button>
        </div>
        <div class="note" style="margin-top:10px">Opțional: încarcă <b>logo PNG</b> pentru watermark.
          <input type="file" id="wmUpload" accept="image/png" aria-label="Încarcă logo pentru watermark">
        </div>
      </div>
    </div>
  </section>

  <!-- ============ DOCUMENTE (ÎNLOCUIT CU COLABORARE) ============ -->
  <section class="card section collab-wrap" id="documente" style="display:none">
    <h2>Modalități de colaborare</h2>
    <div class="collab-note">Alege varianta de colaborare cu platforma. Calculul este orientativ.</div>

    <div class="collab-options">
      <div class="collab-option" id="opt-firma">
        <h3>Varianta 1 – Cu firmă (PFA/SRL)</h3>
        <ul>
          <li>Bucătarul emite factură către Platformă.</li>
          <li>Plata se face integral conform onorariului agreat, <b>minus comisionul</b> de platformă.</li>
        </ul>
      </div>
      <div class="collab-option" id="opt-fara">
        <h3>Varianta 2 – Fără firmă</h3>
        <ul>
          <li>Plata prin <b>contract de colaborare</b> (persoană fizică).</li>
          <li>Onorariul net este diminuat cu <b>taxele legale</b>, suportate de Platformă.</li>
          <li>Se aplică același comision de platformă.</li>
        </ul>
      </div>
    </div>

    <div class="calc">
      <h3>Calculator orientativ de încasare</h3>
      <div class="row">
        <label for="onorariu">Onorariu bucătar (brut)</label>
        <input type="number" id="onorariu" value="1500" />
      </div>
      <div class="row">
        <label for="comision">Comision platformă (%)</label>
        <input type="number" id="comision" value="20" />
      </div>
      <div class="row" id="row-taxe">
        <label for="taxe">Taxe legale (%)</label>
        <input type="number" id="taxe" value="0" />
      </div>
      <div class="row" id="row-categorie" style="display:none">
        <label for="categorie">Categorie firmă</label>
        <select id="categorie">
          <option value="">Alege...</option>
          <option value="PFA">PFA</option>
          <option value="SRL">SRL</option>
        </select>
      </div>
      <div class="result" id="rezultat">Net estimat: 1.200 lei</div>
    </div>

    <div class="calc" id="formular-colaborare">
      <h3>Formular de colaborare</h3>
      <div class="note">Completează datele corespunzătoare variantei alese. Contractul se va genera automat cu aceste date.</div>

      <!-- FORM FIRMĂ -->
      <div id="form-firma" style="display:none">
        <div class="row">
          <label for="firma-denumire">Denumire firmă / Nume titular</label><input id="firma-denumire"/>
        </div>
        <div class="row"><label for="firma-cui">CUI / CIF (PFA: CNP)</label><input id="firma-cui"/></div>
        <div class="row"><label for="firma-reg">Nr. Reg. Com. / Nr. autorizație</label><input id="firma-reg"/></div>
        <div class="row"><label for="firma-sediu">Sediu social / Domiciliu</label><input id="firma-sediu"/></div>
        <div class="row"><label for="firma-repr">Reprezentant (SRL) / Titular (PFA)</label><input id="firma-repr"/></div>
        <div class="row"><label for="firma-email">Email</label><input id="firma-email" type="email"/></div>
        <div class="row"><label for="firma-tel">Telefon</label><input id="firma-tel"/></div>
        <div class="row"><label for="firma-iban">IBAN</label><input id="firma-iban"/></div>
        <div class="row"><label for="firma-banca">Banca</label><input id="firma-banca"/></div>
      </div>

      <!-- FORM PERSOANĂ FIZICĂ -->
      <div id="form-pf" style="display:none">
        <div class="row"><label for="pf-nume">Nume complet</label><input id="pf-nume"/></div>
        <div class="row"><label for="pf-cnp">CNP</label><input id="pf-cnp"/></div>
        <div class="row"><label for="pf-adresa">Adresă</label><input id="pf-adresa"/></div>
        <div class="row"><label for="pf-email">Email</label><input id="pf-email" type="email"/></div>
        <div class="row"><label for="pf-tel">Telefon</label><input id="pf-tel"/></div>
        <div class="row"><label for="pf-iban">IBAN (opțional)</label><input id="pf-iban"/></div>
        <div class="row"><label for="pf-banca">Banca (opțional)</label><input id="pf-banca"/></div>
      </div>

      <div class="row" style="justify-content:flex-start; gap:12px">
        <button class="btn-save" id="form-save" type="button">Salvează formular</button>
        <button class="btn-outline" id="form-gen" type="button">Generează contract</button>
        <span id="form-msg" class="result" style="font-weight:500"></span>
      </div>
    </div>
  </section>
  <!-- ============ /DOCUMENTE ============ -->

  <!-- GALERIE -->
  <section class="card section" id="galerie" style="display:none">
    <h2>Galerie (maxim 6 poze)</h2>
    <div class="warn"><i class="fa-solid fa-triangle-exclamation"></i> Pozele trebuie să fie <b>reale</b>, nu copiate. (max 2MB/poză)</div>
    <label for="gal-upload" class="note">Adaugă imagini</label>
    <input type="file" id="gal-upload" accept="image/*" multiple>
    <div id="gal-wrap" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:10px;margin-top:10px"></div>
    <div class="note" id="gal-note" aria-live="polite"></div>
  </section>

  <!-- MENIURI -->
  <section class="card section" id="meniuri" style="display:none">
    <h2>Meniuri & calcule</h2>
    <p class="note">preț bucătar = persoane × preparate × tarif → total client = preț bucătar × (1 + comision/100)</p>
    <div class="grid">
      <div class="card">
        <h3><i class="fa-solid fa-bowl-food"></i> Tradițional</h3>
        <table class="table" aria-label="Calculator Tradițional"><thead><tr><th>Nr. persoane</th><th>Nr. preparate</th><th>Tarif</th><th>Comision (%)</th><th>Preț bucătar</th><th>Total client</th></tr></thead>
          <tbody><tr>
            <td><input type="number" id="fam-pers" value="10" min="0"></td>
            <td><input type="number" id="fam-prep" value="5" min="0"></td>
            <td><input type="number" id="fam-tarif" value="35" min="0"></td>
            <td><input type="number" id="fam-comm" value="20" min="0"></td>
            <td><input type="text" id="fam-chef" readonly></td>
            <td><input type="text" id="fam-total" readonly></td>
          </tr></tbody>
        </table>
      </div>
      <div class="card">
        <h3><i class="fa-solid fa-champagne-glasses"></i> Fine Dining</h3>
        <table class="table" aria-label="Calculator Fine Dining"><thead><tr><th>Nr. persoane</th><th>Nr. preparate</th><th>Tarif</th><th>Comision (%)</th><th>Preț bucătar</th><th>Total client</th></tr></thead>
          <tbody><tr>
            <td><input type="number" id="priv-pers" value="6" min="0"></td>
            <td><input type="number" id="priv-prep" value="4" min="0"></td>
            <td><input type="number" id="priv-tarif" value="60" min="0"></td>
            <td><input type="number" id="priv-comm" value="20" min="0"></td>
            <td><input type="text" id="priv-chef" readonly></td>
            <td><input type="text" id="priv-total" readonly></td>
          </tr></tbody>
        </table>
      </div>
      <div class="card">
        <h3><i class="fa-solid fa-crown"></i> Premium</h3>
        <table class="table" aria-label="Calculator Premium"><thead><tr><th>Nr. persoane</th><th>Nr. preparate</th><th>Tarif</th><th>Comision (%)</th><th>Preț bucătar</th><th>Total client</th></tr></thead>
          <tbody><tr>
            <td><input type="number" id="corp-pers" value="20" min="0"></td>
            <td><input type="number" id="corp-prep" value="6" min="0"></td>
            <td><input type="number" id="corp-tarif" value="45" min="0"></td>
            <td><input type="number" id="corp-comm" value="15" min="0"></td>
            <td><input type="text" id="corp-chef" readonly></td>
            <td><input type="text" id="corp-total" readonly></td>
          </tr></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- CERERI + CHAT -->
  <section class="card section" id="cereri" style="display:none">
    <h2>Cererile mele</h2>
    <div class="req-layout">
      <aside class="req-list" id="req-list" aria-label="Lista cereri"></aside>
      <div class="chat" aria-label="Chat cerere activă">
        <div class="chat-messages" id="chat"></div>
        <div class="chat-input">
          <label for="chat-input" class="visually-hidden" style="position:absolute;left:-9999px">Mesaj chat</label>
          <input id="chat-input" placeholder="Scrie un mesaj...">
          <button id="chat-send" type="button" class="btn primary"><i class="fa-solid fa-paper-plane"></i> Trimite</button>
        </div>
      </div>
    </div>
  </section>

  <!-- FINANCIAR -->
  <section class="card section" id="financiar" style="display:none">
    <h2>Financiar</h2>
    <div class="wallet">
      <div class="stat"><div class="note">Credit disponibil</div><strong id="credit">5 000 lei</strong></div>
      <div class="stat"><div class="note">Sold curent</div><strong id="sold">0 lei</strong></div>
      <div class="stat"><div class="note">Plăți recente</div><div id="payments" class="note">—</div></div>
    </div>
    <div class="card" style="margin-top:12px">
      <h3 style="margin:0 0 8px">Cont bancar</h3>
      <div class="grid">
        <div><label for="bank-name">Nume bancă</label><input id="bank-name" placeholder="BCR / BT / ING"></div>
        <div><label for="bank-iban">IBAN</label><input id="bank-iban" placeholder="ROxx BANK xxxx xxxx xxxx xxxx" autocomplete="off"></div>
      </div>
      <div style="margin-top:10px;display:flex;gap:10px;align-items:center">
        <button id="bank-save" type="button" class="btn primary"><i class="fa-solid fa-floppy-disk"></i> Salvează</button>
        <div id="bank-msg" class="note" aria-live="polite"></div>
      </div>
      <div class="note" style="margin-top:6px">🔒 Pentru siguranță, IBAN-ul nu se salvează în browser. Se păstrează doar numele băncii și un IBAN mascat.</div>
    </div>
  </section>
</div>

<div id="overlay" class="overlay" role="dialog" aria-modal="true">
  ⚠️ Trebuie să încarci o poză de portret validă pentru a continua în dashboard.
  (Apasă Esc pentru a închide acest mesaj)
  <div style="margin-top:12px;display:flex;gap:8px;justify-content:center;flex-wrap:wrap">
    <button id="overlay-close" type="button" class="btn">Înțeleg</button>
    <button id="overlay-close-remember" type="button" class="btn primary">Nu mai arăta</button>
  </div>
</div>

<script>
(()=>{
  // ==== Safe storage
  const Store = (()=>{try{const t='__t__';localStorage.setItem(t,'1');localStorage.removeItem(t);return localStorage;}catch(e){const mem={};return{getItem:k=>mem[k]||null,setItem:(k,v)=>mem[k]=String(v),removeItem:k=>delete mem[k]};}})();
  const getJSON=(k,d)=>{try{const v=Store.getItem(k);return v?JSON.parse(v):d}catch(e){return d}};
  const setJSON=(k,v)=>{try{Store.setItem(k,JSON.stringify(v))}catch(e){}};

  const nf=new Intl.NumberFormat('ro-RO');
  const fmt=n=>nf.format(Math.round(+n||0));
  const fmtRON=n=>fmt(n)+' lei';

  // ===== Helpers: validators =====
  function isValidEmail(e){return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e||'');}
  function isValidRomanianIBAN(ibanRaw){
    const iban=(ibanRaw||'').replace(/\s+/g,'').toUpperCase();
    if(!/^RO[0-9A-Z]{22}$/.test(iban)) return false; // 24 total
    const rearr=iban.slice(4)+iban.slice(0,4);
    const expanded=rearr.replace(/[A-Z]/g,ch=>(ch.charCodeAt(0)-55).toString());
    let remainder=0;
    for(let i=0;i<expanded.length;i+=7){
      const part=(''+remainder)+expanded.substring(i,i+7);
      remainder=parseInt(part,10)%97;
    }
    return remainder===1;
  }
  const maskIban = (iban)=> (iban||'').replace(/\s+/g,'').replace(/^(.{6}).+(.{4})$/,'$1••••••••••••$2');

  // ===== Progress elements
  const pb=document.getElementById('progress-bar');
  const pl=document.getElementById('progress-label');
  const pt=document.getElementById('progress-tips');

  // ===== Progress (5 pași): Portret, Colaborare, Galerie, Meniuri, Bancă+IBAN
  function computeProgress(){
    let total=5, ok=0; const tips=[];
    // 1) Portret
    const portrait=Store.getItem('PORTRAIT');
    if(portrait){ ok++; } else { tips.push('Încarcă portretul în tunica oficială.'); }

    // 2) Documente -> Colaborare: tip selectat + câmpuri minime
    const type=localStorage.getItem('COLAB_TYPE')||'';
    let collabOK=false;
    if(type==='firma'){
      const d=JSON.parse(localStorage.getItem('FORM_FIRMA')||'{}');
      collabOK = (d?.denumire?.trim() && d?.email && isValidEmail(d.email));
    }else if(type==='fara'){
      const d=JSON.parse(localStorage.getItem('FORM_PF')||'{}');
      collabOK = (d?.nume?.trim() && d?.email && isValidEmail(d.email));
    }
    if(collabOK){ ok++; } else { tips.push('Alege tipul de colaborare și completează formularul (minim nume/denumire + email).'); }

    // 3) Galerie
    const gal=getJSON('GAL',[]); if(gal.length>=6){ ok++; } else { tips.push(`Încarcă 6 poze reale (ai ${gal.length}/6).`); }

    // 4) Meniuri
    const famOk=(+document.getElementById('fam-pers').value>0 && +document.getElementById('fam-prep').value>0 && +document.getElementById('fam-tarif').value>0);
    const privOk=(+document.getElementById('priv-pers').value>0 && +document.getElementById('priv-prep').value>0 && +document.getElementById('priv-tarif').value>0);
    const corpOk=(+document.getElementById('corp-pers').value>0 && +document.getElementById('corp-prep').value>0 && +document.getElementById('corp-tarif').value>0);
    if(famOk && privOk && corpOk){ ok++; } else { tips.push('Completează prețurile la Tradițional, Fine Dining și Premium.'); }

    // 5) Bancă
    const bankName=(document.getElementById('bank-name').value||'').trim();
    const bankIban=(document.getElementById('bank-iban').value||'').trim();
    if(bankName && isValidRomanianIBAN(bankIban)){ ok++; } else { tips.push('Adaugă numele băncii și un IBAN RO valid.'); }

    const pct=Math.round(ok/total*100);
    pb.style.width=pct+'%'; pl.textContent=pct+'%';
    pt.innerHTML = (pct===100) ? '✅ Cont complet activat.' : 'Pași rămași: ' + tips.join(' • ');
  }

  // ===== Tabs + blocare până la portret valid
  let hasValidPortrait=false;
  const tabs=document.getElementById('tabs');
  const sections={profil:'profil',documente:'documente',galerie:'galerie',meniuri:'meniuri',cereri:'cereri',financiar:'financiar'};
  function show(id){ Object.values(sections).forEach(s=>document.getElementById(s).style.display='none'); document.getElementById(id).style.display='block'; }
  function activateTab(t){
    tabs.querySelectorAll('.tab').forEach(b=>{b.classList.remove('active'); b.setAttribute('aria-selected','false');});
    t.classList.add('active'); t.setAttribute('aria-selected','true');
    show(sections[t.dataset.tab]);
  }
  tabs.addEventListener('click',e=>{
    const t=e.target.closest('.tab'); if(!t) return;
    if(!hasValidPortrait && !['profil','documente'].includes(t.dataset.tab)){
      // dacă nu e portret și overlay NU a fost dezactivat, afișăm mesajul și blocăm
      if(!Store.getItem('OVERLAY_DISMISSED')){ document.getElementById('overlay').style.display='flex'; return; }
      // altfel permitem navigarea
    }
    activateTab(t);
  });
  tabs.addEventListener('keydown',e=>{
    if(e.key==='Enter' || e.key===' '){
      const t=e.target.closest('.tab'); if(!t) return;
      if(!hasValidPortrait && !['profil','documente'].includes(t.dataset.tab)){
        if(!Store.getItem('OVERLAY_DISMISSED')){ document.getElementById('overlay').style.display='flex'; return; }
      }
      activateTab(t);
    }
  });

  // ===== Profil: upload/cameră + watermark
  const portraitPreview=document.getElementById('portraitPreview');
  const portraitUpload=document.getElementById('portraitUpload');
  const removePortrait=document.getElementById('removePortrait');
  const qualityEl=document.getElementById('quality');
  const overlay=document.getElementById('overlay');
  const overlayClose=document.getElementById('overlay-close');
  const overlayCloseRemember=document.getElementById('overlay-close-remember');
  function closeOverlay(remember=false){ overlay.style.display='none'; if(remember){ Store.setItem('OVERLAY_DISMISSED','1'); } }
  overlayClose?.addEventListener('click', ()=> closeOverlay(false));
  overlayCloseRemember?.addEventListener('click', ()=> closeOverlay(true));
  overlay?.addEventListener('click', (e)=>{ if(e.target===overlay) closeOverlay(false); });
  const wmUpload=document.getElementById('wmUpload');

  let wmLogoData=getJSON('WM_LOGO', null);
  wmUpload?.addEventListener('change',()=>{ const f=wmUpload.files[0]; if(!f) return;
    if(f.size>2_000_000){ alert('Logo prea mare (>2MB).'); wmUpload.value=''; return; }
    const r=new FileReader(); r.onload=e=>{ wmLogoData=e.target.result; Store.setItem('WM_LOGO', wmLogoData); alert('Logo watermark salvat.'); }; r.readAsDataURL(f);
  });

  function checkQuality(imgW,imgH){
    if(imgW<600||imgH<600){ qualityEl.textContent='Calitate: Slabă (minim 600×600px)'; qualityEl.style.color='#dc3545'; return false; }
    const ratio=imgW/imgH; if(ratio<0.8||ratio>1.2){ qualityEl.textContent='Calitate: Acceptabilă (nu este pătrată)'; qualityEl.style.color='#e69500'; return true; }
    qualityEl.textContent='Calitate: Bună'; qualityEl.style.color='#198754'; return true;
  }
  function cropToSquare(img){ const size=Math.min(img.width,img.height); const sx=(img.width-size)/2, sy=(img.height-size)/2; const c=document.createElement('canvas'); c.width=c.height=size; const ctx=c.getContext('2d'); ctx.drawImage(img,sx,sy,size,size,0,0,size,size); return c; }
  function drawWatermark(canvas){ const ctx=canvas.getContext('2d'); ctx.save(); ctx.globalAlpha=0.22; ctx.translate(canvas.width/2, canvas.height/2); ctx.rotate(-Math.PI/6); ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.fillStyle='#0e5a43'; ctx.font=Math.round(canvas.width*0.08)+'px Inter, Arial'; ctx.fillText('BUCĂTARUL PERSONAL', 0, 0); ctx.restore(); if(wmLogoData){ const img=new Image(); img.onload=()=>{ const w=Math.min(canvas.width*0.28, img.width); const h=w*(img.height/img.width); ctx.save(); ctx.globalAlpha=0.35; ctx.drawImage(img, canvas.width-w-14, canvas.height-h-14, w, h); ctx.restore(); }; img.src=wmLogoData; } }
  function processPortrait(dataURL){ const img=new Image(); img.onload=()=>{ const validBase=checkQuality(img.naturalWidth,img.naturalHeight); const squareCanvas=cropToSquare(img); const out=document.createElement('canvas'); out.width=out.height=900; const octx=out.getContext('2d'); octx.drawImage(squareCanvas,0,0,900,900); drawWatermark(out); const finalData=out.toDataURL('image/png'); portraitPreview.src=finalData; Store.setItem('PORTRAIT', finalData); hasValidPortrait = !!validBase; overlay.style.display = hasValidPortrait ? 'none' : 'flex'; computeProgress(); }; img.src=dataURL; }
  const savedPortrait=Store.getItem('PORTRAIT');
  if(savedPortrait){
    portraitPreview.src=savedPortrait; hasValidPortrait=true; overlay.style.display='none'; qualityEl.textContent='Calitate: Bună'; qualityEl.style.color='#198754';
  } else {
    if(!Store.getItem('OVERLAY_DISMISSED')) overlay.style.display='flex';
  }
  portraitUpload.addEventListener('change',()=>{ const f=portraitUpload.files[0]; if(!f) return;
    if(!/image\/(png|jpeg)/.test(f.type)){ alert('Acceptăm doar JPG/PNG'); portraitUpload.value=''; return; }
    if(f.size>2_000_000){ alert('Imagine prea mare (>2MB).'); portraitUpload.value=''; return; }
    const r=new FileReader(); r.onload=e=>processPortrait(e.target.result); r.readAsDataURL(f);
  });
  removePortrait.addEventListener('click',()=>{ Store.removeItem('PORTRAIT'); portraitPreview.src='https://via.placeholder.com/300x300.png?text=Portret'; hasValidPortrait=false; overlay.style.display='flex'; qualityEl.textContent=''; computeProgress(); });
  document.getElementById('cameraBtn').addEventListener('click', async()=>{ try{
      const stream=await navigator.mediaDevices.getUserMedia({video:{width:{ideal:1920},height:{ideal:1080}}});
      const video=document.createElement('video'); video.srcObject=stream; await video.play();
      setTimeout(()=>{ const c=document.createElement('canvas'); c.width=c.height=900; const ctx=c.getContext('2d'); const side=Math.min(video.videoWidth,video.videoHeight); const sx=(video.videoWidth-side)/2; const sy=(video.videoHeight-side)/2; ctx.drawImage(video, sx, sy, side, side, 0,0,900,900); drawWatermark(c); const data=c.toDataURL('image/png'); processPortrait(data); stream.getTracks().forEach(t=>t.stop()); }, 1000);
    }catch(err){ alert('Nu am acces la cameră. Încarcă o poză manual.'); }
  });

  // ===== Galerie
  const gInput=document.getElementById('gal-upload'); const gWrap=document.getElementById('gal-wrap'); const gNote=document.getElementById('gal-note');
  function renderGal(){
    const arr=getJSON('GAL',[]);
    gWrap.innerHTML=arr.map(s=>`<img src="${s}" loading="lazy" alt="Foto din galerie" style="width:100%;aspect-ratio:1/1;object-fit:cover;border-radius:12px;border:1px solid #e8ecee"/>`).join('');
    gNote.textContent=`${arr.length}/6 încărcate`; computeProgress();
  }
  if(gInput){
    gInput.addEventListener('change',()=>{
      let arr=getJSON('GAL',[]);
      [...gInput.files].forEach(f=>{
        if(arr.length>=6) return;
        if(f.size>2_000_000){ alert(`"${f.name}" depășește 2MB și a fost omisă.`); return; }
        const r=new FileReader(); r.onload=e=>{ arr.push(e.target.result); setJSON('GAL',arr); renderGal(); }; r.readAsDataURL(f);
      });
      gInput.value='';
    });
    renderGal();
  }

  // ===== Meniuri calc
  function bindCalc(p){
    const id=s=>document.getElementById(`${p}-${s}`);
    const pers=id('pers'),prep=id('prep'),tarif=id('tarif'),comm=id('comm'),chef=id('chef'),total=id('total');
    const rec=()=>{ const pp=+pers.value||0, nn=+prep.value||0, tt=+tarif.value||0, cc=(+comm.value||0)/100; const chefV=Math.max(0,pp*nn*tt); const tot=chefV*(1+cc); chef.value=fmt(chefV); total.value=fmt(tot); computeProgress(); };
    [pers,prep,tarif,comm].forEach(el=>el&&el.addEventListener('input',rec));
    rec();
  }
  ['fam','priv','corp'].forEach(bindCalc);

  // ===== Cereri + chat (demo)
  const reqList=document.getElementById('req-list'); const chat=document.getElementById('chat'); const chatInput=document.getElementById('chat-input');
  let reqs=getJSON('REQS',[]); if(!reqs.length){ reqs=[{id:'CER-9001',titlu:'Cină privată 6 pers',data:'2025-08-20',oras:'București',status:'pending',buget:2500}]; setJSON('REQS',reqs); }
  let active=reqs[0].id;
  function renderReqs(){ reqList.innerHTML=reqs.map(r=>`<div class="req-item ${r.id===active?'active':''}" data-id="${r.id}"><div><strong>${r.titlu}</strong><div class="note">${r.data} • ${r.oras} • ${fmtRON(r.buget)}</div></div><span class="badge ${r.status}">${r.status}</span></div>`).join(''); }
  function openReq(id){ active=id; renderReqs(); const msgs=getJSON('CHAT_'+id,[]); chat.innerHTML=msgs.map(m=>`<div class="msg ${m.me?'me':'them'}">${m.text}</div>`).join(''); chat.scrollTop=chat.scrollHeight; }
  reqList.addEventListener('click',e=>{ const it=e.target.closest('.req-item'); if(!it) return; openReq(it.dataset.id); });
  renderReqs(); openReq(active);
  document.getElementById('chat-send').addEventListener('click',()=>{ const t=(chatInput.value||'').trim(); if(!t) return; const k='CHAT_'+active; const arr=getJSON(k,[]); arr.push({me:true,text:t,ts:Date.now()}); setJSON(k,arr); chatInput.value=''; openReq(active); });
  chatInput.addEventListener('keydown', e=>{
    if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); document.getElementById('chat-send').click(); }
  });

  // ===== Financiar – bancă + IBAN (no PII storage)
  const bankName=document.getElementById('bank-name'); const bankIban=document.getElementById('bank-iban'); const bankMsg=document.getElementById('bank-msg');
  const bankMeta=getJSON('BANK_META',{}); if(bankMeta.name) bankName.value=bankMeta.name;
  document.getElementById('bank-save').addEventListener('click',()=>{
    const name=(bankName.value||'').trim(); const iban=(bankIban.value||'').trim().toUpperCase();
    if(!name){bankMsg.textContent='Introdu numele băncii.';return;}
    if(!isValidRomanianIBAN(iban)){bankMsg.textContent='IBAN invalid pentru România.';return;}
    setJSON('BANK_META',{name, iban_mask: maskIban(iban)});
    bankMsg.textContent='Date bancare salvate local (IBAN mascat).';
    computeProgress();
  });

  // ===== Overlay ESC shortcut
  document.addEventListener('keydown', e=>{
    if(e.key==='Escape'){ overlay.style.display='none'; Store.setItem('OVERLAY_DISMISSED','1'); }
  });

  // ===== Noua secțiune Documente: colaborare
  const optFirma = document.getElementById('opt-firma');
  const optFara = document.getElementById('opt-fara');
  const rowTaxe = document.getElementById('row-taxe');
  const onorariuInput = document.getElementById('onorariu');
  const comisionInput = document.getElementById('comision');
  const taxeInput = document.getElementById('taxe');
  const rezultat = document.getElementById('rezultat');
  const rowCategorie = document.getElementById('row-categorie');
  const categorieSelect = document.getElementById('categorie');

  // Firma fields
  const f_denumire = document.getElementById('firma-denumire');
  const f_cui = document.getElementById('firma-cui');
  const f_reg = document.getElementById('firma-reg');
  const f_sediu = document.getElementById('firma-sediu');
  const f_repr = document.getElementById('firma-repr');
  const f_email = document.getElementById('firma-email');
  const f_tel = document.getElementById('firma-tel');
  const f_iban = document.getElementById('firma-iban');
  const f_banca = document.getElementById('firma-banca');
  // PF fields
  const p_nume = document.getElementById('pf-nume');
  const p_cnp = document.getElementById('pf-cnp');
  const p_adresa = document.getElementById('pf-adresa');
  const p_email = document.getElementById('pf-email');
  const p_tel = document.getElementById('pf-tel');
  const p_iban = document.getElementById('pf-iban');
  const p_banca = document.getElementById('pf-banca');

  const formSaveBtn = document.getElementById('form-save');
  const formGenBtn = document.getElementById('form-gen');
  const formMsg = document.getElementById('form-msg');
  const formFirma = document.getElementById('form-firma');
  const formPF = document.getElementById('form-pf');

  function calculeaza() {
    const onorariu = parseFloat(onorariuInput.value) || 0;
    const comision = parseFloat(comisionInput.value) || 0;
    const taxe = parseFloat(taxeInput.value) || 0;
    let dupaComision = onorariu - (onorariu * comision / 100);
    let net = dupaComision - (dupaComision * taxe / 100);
    rezultat.textContent = `Net estimat: ${net.toFixed(2)} lei`;
  }
  onorariuInput.addEventListener('input', calculeaza);
  comisionInput.addEventListener('input', calculeaza);
  taxeInput.addEventListener('input', calculeaza);
  categorieSelect.addEventListener('change', ()=>{ localStorage.setItem('FIRMA_CATEGORIE', categorieSelect.value || ''); });

  function saveForms(){
    const type = localStorage.getItem('COLAB_TYPE')||'firma';
    if(type==='firma'){
      const data={categorie:categorieSelect.value,denumire:f_denumire.value,cui:f_cui.value,reg:f_reg.value,sediu:f_sediu.value,repr:f_repr.value,email:f_email.value,tel:f_tel.value,iban:f_iban.value,banca:f_banca.value};
      localStorage.setItem('FORM_FIRMA', JSON.stringify(data));
      return data;
    } else {
      const data={nume:p_nume.value,cnp:p_cnp.value,adresa:p_adresa.value,email:p_email.value,tel:p_tel.value,iban:p_iban.value,banca:p_banca.value};
      localStorage.setItem('FORM_PF', JSON.stringify(data));
      return data;
    }
  }
  function loadForms(){
    const type = localStorage.getItem('COLAB_TYPE')||'firma';
    if(type==='firma'){
      const d=JSON.parse(localStorage.getItem('FORM_FIRMA')||'{}');
      if(d.categorie) categorieSelect.value=d.categorie;
      f_denumire.value=d.denumire||''; f_cui.value=d.cui||''; f_reg.value=d.reg||''; f_sediu.value=d.sediu||''; f_repr.value=d.repr||''; f_email.value=d.email||''; f_tel.value=d.tel||''; f_iban.value=d.iban||''; f_banca.value=d.banca||'';
    } else {
      const d=JSON.parse(localStorage.getItem('FORM_PF')||'{}');
      p_nume.value=d.nume||''; p_cnp.value=d.cnp||''; p_adresa.value=d.adresa||''; p_email.value=d.email||''; p_tel.value=d.tel||''; p_iban.value=d.iban||''; p_banca.value=d.banca||'';
    }
  }
  formSaveBtn.addEventListener('click', (e)=>{ e.preventDefault(); saveForms(); formMsg.textContent='Formular salvat.'; computeProgress(); });

  function contractHTML(){
    const type = localStorage.getItem('COLAB_TYPE')||'firma';
    const today = new Date().toLocaleDateString('ro-RO');
    if(type==='firma'){
      const d=JSON.parse(localStorage.getItem('FORM_FIRMA')||'{}');
      const cat=d.categorie||'PFA';
      return `<!doctype html><html><head><meta charset="utf-8"><title>Contract colaborare</title><style>body{font-family:Inter,Arial,sans-serif;padding:24px;line-height:1.45} h1{font-size:20px;color:#0e5a43} h2{font-size:16px;margin-top:18px} .meta{color:#555;font-size:13px}</style></head><body>
      <h1>Contract de colaborare – ${cat}</h1>
      <div class="meta">Data: ${today}</div>
      <h2>Părți</h2>
      <p><b>${d.denumire||'[denumire]'}</b>, ${cat}, CUI/CIF ${d.cui||'-'}, Reg. ${d.reg||'-'}, cu sediul în ${d.sediu||'-'}, reprezentată de ${d.repr||'-'}, denumită în continuare „Colaborator”.</p>
      <p>și Platforma „Bucătarul Personal”, denumită în continuare „Platforma”.</p>
      <h2>Obiect</h2>
      <p>Prestarea de servicii culinare pentru clienții Platformei, conform comenzilor acceptate.</p>
      <h2>Plăți</h2>
      <p>Plata se efectuează conform onorariului agreat, din care se reține comisionul Platformei. IBAN: ${d.iban||'-'}, Banca: ${d.banca||'-'}.</p>
      <h2>Contact</h2>
      <p>Email: ${d.email||'-'} • Telefon: ${d.tel||'-'}</p>
      <br><br>
      <p>Semnături:</p>
      <p>Colaborator: _______________________ &nbsp;&nbsp; Platforma: _______________________</p>
      </body></html>`;
    } else {
      const d=JSON.parse(localStorage.getItem('FORM_PF')||'{}');
      return `<!doctype html><html><head><meta charset="utf-8"><title>Contract colaborare PF</title><style>body{font-family:Inter,Arial,sans-serif;padding:24px;line-height:1.45} h1{font-size:20px;color:#0e5a43} h2{font-size:16px;margin-top:18px} .meta{color:#555;font-size:13px}</style></head><body>
      <h1>Contract de colaborare – Persoană fizică</h1>
      <div class="meta">Data: ${today}</div>
      <h2>Părți</h2>
      <p><b>${d.nume||'[nume complet]'}</b>, CNP ${d.cnp||'-'}, domiciliat(ă) în ${d.adresa||'-'}, denumit(ă) „Colaborator”.</p>
      <p>și Platforma „Bucătarul Personal”, denumită în continuare „Platforma”.</p>
      <h2>Obiect</h2>
      <p>Prestarea de servicii culinare pentru clienții Platformei, conform comenzilor acceptate.</p>
      <h2>Plăți</h2>
      <p>Plata netă se calculează după reținerea comisionului și taxelor legale. IBAN: ${d.iban||'-'}, Banca: ${d.banca||'-'}.</p>
      <h2>Contact</h2>
      <p>Email: ${d.email||'-'} • Telefon: ${d.tel||'-'}</p>
      <br><br>
      <p>Semnături:</p>
      <p>Colaborator: _______________________ &nbsp;&nbsp; Platforma: _______________________</p>
      </body></html>`;
    }
  }
  document.getElementById('form-gen').addEventListener('click',(e)=>{ e.preventDefault(); saveForms(); const html=contractHTML(); const w=window.open('about:blank','_blank'); if(!w){ alert('Deblochează pop-up-urile pentru a vedea contractul.'); return;} w.document.write(html); w.document.close(); try{ w.focus(); w.print(); }catch(_){} });

  function applyTypeUI(){ const t=localStorage.getItem('COLAB_TYPE')||'firma'; if(t==='firma'){ formFirma.style.display='block'; formPF.style.display='none'; rowCategorie.style.display='flex'; rowTaxe.style.display='none'; } else { formFirma.style.display='none'; formPF.style.display='block'; rowCategorie.style.display='none'; rowTaxe.style.display='flex'; } loadForms(); calculeaza(); computeProgress(); }
  document.getElementById('opt-firma').addEventListener('click',()=>{ localStorage.setItem('COLAB_TYPE','firma'); optFirma.classList.add('active'); optFara.classList.remove('active'); applyTypeUI(); });
  document.getElementById('opt-fara').addEventListener('click',()=>{ localStorage.setItem('COLAB_TYPE','fara'); optFara.classList.add('active'); optFirma.classList.remove('active'); applyTypeUI(); });

  // init
  const savedType = localStorage.getItem('COLAB_TYPE') || 'firma';
  (savedType==='fara' ? optFara : optFirma).click();

  // initial compute
  computeProgress();
})();
</script>
</body>
</html>

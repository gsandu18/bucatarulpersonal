<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bucătarul Personal · AI Nutriție – Mese zilnice acasă</title>
  <meta name="description" content="Generează un meniu săptămânal personalizat cu AI pentru mese zilnice acasă. Alege preferințe, calorii și ținta de proteine. Export PDF și trimitere pe email pentru abonamentul PRO." />
  <meta name="theme-color" content="#0e5a43" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&family=Playfair+Display:wght@600;700&display=swap" rel="stylesheet" />
  <style>
    :root{
      --green:#0e5a43; --green-2:#0a4a35; --deep:#081a14; --gold:#c9a227;
      --text:#172422; --muted:#5b6a66; --bg:#f6faf7; --white:#fff; --line:#e7ece8; --r:18px; --shadow:0 12px 36px rgba(0,0,0,.07);
      --max:1180px; --hero-img: url('https://images.unsplash.com/photo-1512621776951-a57141f2eefd?q=80&w=1920&auto=format&fit=crop');
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    a{color:var(--green)}
    .container{max-width:var(--max);margin:0 auto;padding:24px}
    header{color:var(--white);background:
      linear-gradient(120deg, rgba(8,26,20,.82), rgba(10,74,53,.82)),
      var(--hero-img);
    background-size:cover;background-position:center}
    header .container{padding:28px 24px 36px}
    .topbar{display:flex;align-items:center;gap:16px;justify-content:space-between}
    .brand{display:flex;align-items:center;gap:12px}
    .brand .logo{width:36px;height:36px;border-radius:50%;background:transparent;border:2px solid var(--gold);display:grid;place-items:center;box-shadow:none}
    .brand .logo span{font-weight:800;color:var(--gold);font-size:14px;letter-spacing:.5px}
    .brand h1{font-family:"Playfair Display",serif;font-weight:700;font-size:22px;letter-spacing:.5px;margin:0}
    .hero{display:grid;grid-template-columns:1.2fr .8fr;gap:28px;margin-top:18px}
    .hero h2{font-family:"Playfair Display",serif;font-size:36px;line-height:1.2;margin:0 0 8px}
    .hero p{margin:0 0 16px;color:#e8f2ee}
    .hero .badges{display:flex;gap:10px;flex-wrap:wrap}
    .pill{display:inline-flex;align-items:center;gap:8px;border:1px solid rgba(255,255,255,.25);color:#eaf5f0;padding:6px 10px;border-radius:999px;font-size:12px}
    .card{background:var(--white);border:1px solid var(--line);border-radius:var(--r);box-shadow:var(--shadow)}
    .card.pad{padding:20px}
    .grid{display:grid;gap:14px}
    .grid-2{grid-template-columns:1fr 1fr}
    .grid-3{grid-template-columns:repeat(3,1fr)}
    .grid-4{grid-template-columns:repeat(4,1fr)}
    label{font-weight:600;font-size:14px}
    input,select,textarea{width:100%;padding:12px 14px;border:1px solid var(--line);border-radius:12px;background:#fff;color:var(--text);font-size:14px}
    textarea{min-height:86px;resize:vertical}
    .hint{font-size:12px;color:var(--muted)}
    .btn{appearance:none;border:none;cursor:pointer;border-radius:14px;padding:12px 16px;font-weight:700}
    .btn-primary{background:var(--green);color:#fff}
    .btn-primary:hover{background:var(--green-2)}
    .btn-ghost{background:transparent;border:1px solid var(--line);color:var(--green)}
    .btn[disabled]{opacity:.55;cursor:not-allowed}
    .actions{display:flex;gap:10px;flex-wrap:wrap}
    .section{margin:24px 0}

    /* Hero image (overlay) */
    .heroimg{display:none !important}
    header .card.pad{background:rgba(255,255,255,.94);border-color:rgba(255,255,255,.55);backdrop-filter:saturate(1.15) blur(2px);color:var(--text)}
    header .card.pad .hint{color:var(--muted)}
    header .card.pad label{color:var(--text)}
    header .card.pad input::placeholder{color:#8fa7a0}
    .hero-right{display:grid;gap:14px;align-content:start}

    /* Access bar */
    .access{display:flex;flex-wrap:wrap;gap:12px;align-items:center}
    .status{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;font-weight:700;font-size:12px}
    .ok{background:#e9f8f1;color:#185a3f;border:1px solid #b9ead2}
    .warn{background:#fff7e8;color:#7a5305;border:1px solid #ffe0a3}

    /* Validation */
    .input-error{border-color:#e24545 !important; box-shadow:0 0 0 3px rgba(226,69,69,.08)}
    .field-msg{font-size:12px;color:#b23b3b;margin-top:6px;display:none}
    .field-msg.show{display:block}

    /* Tabs styling (improved) */
    .tabs{display:flex;gap:10px;margin-top:8px}
    .tab{appearance:none;padding:10px 14px;border-radius:999px;border:1px solid rgba(255,255,255,.35);cursor:pointer;font-weight:700;background:rgba(255,255,255,.92);color:var(--text);transition:all .2s ease;box-shadow:0 1px 0 rgba(0,0,0,.04)}
    .tab:hover{transform:translateY(-1px);box-shadow:0 6px 18px rgba(0,0,0,.12)}
    .tabs .tab.active{background:var(--green);color:#fff;border-color:var(--green);box-shadow:0 10px 24px rgba(14,90,67,.28)}
    .tab:focus-visible{outline:none;box-shadow:0 0 0 3px rgba(14,90,67,.35)}

    /* Table */
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid var(--line);text-align:left;font-size:14px;vertical-align:top}
    th{background:#f7fbf8;font-weight:800}
    tfoot td{font-weight:800}

    /* Day selector */
    .days{display:flex;gap:8px;flex-wrap:wrap;margin:12px 0}
    .day{padding:8px 10px;border-radius:10px;border:1px solid var(--line);cursor:pointer;background:#fff}
    .day.active{background:var(--green);color:#fff;border-color:var(--green)}

    /* Shopping list */
    .chips{display:flex;gap:8px;flex-wrap:wrap}
    .chip{border:1px solid var(--line);padding:8px 10px;border-radius:999px;background:#fff}

    /* Toast */
    .toast{position:fixed;inset:auto 16px 16px auto;background:#0e5a43;color:#fff;padding:12px 14px;border-radius:12px;box-shadow:var(--shadow);opacity:0;transform:translateY(10px);transition:all .25s ease;z-index:50}
    .toast.show{opacity:1;transform:translateY(0)}
    .toast.error{background:#b23b3b}

    /* Footer */
    footer{margin:40px 0 24px;color:var(--muted);font-size:13px}

    /* Print styles */
    @media print{
      header,.access,.tabs,.actions,.faq,footer,.toast{display:none!important}
      body{background:#fff}
      .card{box-shadow:none;border:none}
      .container{padding:0}
    }

    /* Responsive */
    @media (max-width:960px){
      .hero{grid-template-columns:1fr}
      .grid-2{grid-template-columns:1fr}
      .grid-3{grid-template-columns:1fr}
      .grid-4{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <header>
    <div class="container">
      <div class="topbar">
        <div class="brand">
          <div class="logo" aria-label="Monogramă cerc auriu"><span>BP</span></div>
         <h1>BUCĂTARUL PERSONAL</h1>
        </div>
        <div class="pill" title="Datele sunt anonimizate și nu sunt partajate către terți.">GDPR Ready</div>
      </div>
      <div class="hero">
        <div>
          <h2>AI Nutriție – meniuri zilnice, <em>gourmet</em>, la tine acasă</h2>
          <p>Setezi obiectivul tău (ex: <strong>2.400 kcal</strong> și <strong>160 g proteine/zi</strong>) și primești un meniu săptămânal cu mic dejun, prânz, cină și gustare + listă de cumpărături.</p>
          <div class="badges">
            <span class="pill">✔️ Personalizat după preferințe & alergii</span>
            <span class="pill">✔️ Export PDF</span>
            <span class="pill">✔️ Trimitere pe email</span>
          </div>
        </div>
        <div class="hero-right">
          <figure class="heroimg" aria-hidden="true">
            <img id="heroImg"
                 src="https://images.unsplash.com/photo-1512621776951-a57141f2eefd?q=80&w=1640&auto=format&fit=crop"
                 srcset="https://images.unsplash.com/photo-1512621776951-a57141f2eefd?q=80&w=1640&auto=format&fit=crop 1x, https://images.unsplash.com/photo-1512621776951-a57141f2eefd?q=80&w=3280&auto=format&fit=crop 2x"
                 sizes="(max-width: 960px) 100vw, 520px"
                 alt="Mese sănătoase gătite acasă – AI Nutriție" loading="lazy" decoding="async" fetchpriority="high" />
          </figure>
          <div class="card pad">
            <div class="access">
              <div class="status warn" id="accessStatus">Acces standard – funcții PRO blocate</div>
              <div class="status warn" id="demoCounter" style="display:none"></div>
              <div style="flex:1;min-width:220px">
                <label for="accessCode">Cod acces (abonament <strong>SUB-</strong> sau client existent <strong>BP8/BP12/BP20</strong>)</label>
                <input id="accessCode" placeholder="Ex: SUB-ABCD" />
                <div class="hint">Activezi modul PRO fie cu un <strong>cod de abonament SUB-</strong>, fie cu un cod de <strong>client existent</strong>.</div>
              </div>
              <button class="btn btn-primary" onclick="checkAccess()">Activează</button>
            </div>
          </div>
        </div>
      </div>
      <div class="tabs">
        <button type="button" class="tab active" data-tab="ai">AI rapid</button>
        <button type="button" class="tab" data-tab="expert">Consultă un nutriționist</button>
      </div>
    </div>
  </header>

  <main class="container">
    <div class="tabpanes">
      <!-- TAB: AI -->
      <div id="tab-ai" class="active">
        <section class="section card pad">
          <h3 style="margin:0 0 12px;font-size:20px">Date & preferințe</h3>
          <div class="grid grid-2">
            <div>
              <label for="nume">Nume</label>
              <input id="nume" placeholder="Nume și prenume" />
            </div>
            <div>
              <label for="email">Email</label>
              <input id="email" placeholder="prenume@exemplu.com" type="email" />
            </div>
            <div>
              <label for="telefon">Telefon</label>
              <input id="telefon" placeholder="07xx xxx xxx" />
            </div>
            <div>
              <label for="oras">Oraș</label>
              <input id="oras" placeholder="Ex: București / Milano" />
            </div>
            <div>
              <label for="dieta">Tip dietă</label>
              <select id="dieta">
                <option>Normal</option>
                <option>Vegetarian</option>
                <option>Vegan</option>
                <option>Low‑carb</option>
                <option>Keto</option>
                <option>Fără gluten</option>
              </select>
            </div>
            <div>
              <label for="alergii">Alergii / alimente de evitat</label>
              <input id="alergii" placeholder="Ex: lactoză, arahide, crustacee" />
            </div>
            <div>
              <label for="kcal">Calorii pe zi</label>
              <select id="kcal">
                <option value="1800">1.800 kcal</option>
                <option value="2000" selected>2.000 kcal</option>
                <option value="2200">2.200 kcal</option>
                <option value="2400">2.400 kcal</option>
                <option value="2600">2.600 kcal</option>
                <option value="2800">2.800 kcal</option>
                <option value="3000">3.000 kcal</option>
              </select>
            </div>
            <div>
              <label for="proteine">Țintă proteine (g/zi)</label>
              <input id="proteine" type="number" min="60" max="260" step="5" placeholder="Ex: 160" />
              <div class="hint">Sugestie generală: 1.6–2.2 g/kg corp (ex.: 80 kg → 130–175 g/zi).</div>
            </div>
            <div>
              <label for="mese">Mese/zi</label>
              <select id="mese">
                <option value="3">3 mese</option>
                <option value="4" selected>4 mese (cu gustare)</option>
                <option value="5">5 mese</option>
              </select>
            </div>
            <div>
              <label for="bucatarii">Bucătării preferate</label>
              <select id="bucatarii" multiple>
                <option>Românească</option>
                <option>Italiană</option>
                <option>Mediterraneană</option>
                <option>Asiană</option>
                <option>Mexicană</option>
                <option>Orientală</option>
              </select>
              <div class="hint">Ține <strong>Ctrl/Cmd</strong> pentru selecții multiple.</div>
            </div>
            <div>
              <label for="evita">Nu îmi plac</label>
              <input id="evita" placeholder="Ex: măsline, coriandru, pește crud" />
            </div>
          </div>
          <div class="actions" style="margin-top:12px">
            <button class="btn btn-primary" id="btnGen">Generează meniul</button>
            <button class="btn btn-ghost" id="btnPdf" disabled>Descarcă PDF</button>
            <button class="btn btn-ghost" id="btnMail" disabled>Trimite pe e‑mail</button>
          </div>
        </section>

        <section class="section grid grid-2">
          <div class="card pad">
            <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:8px">
              <h3 style="margin:0;font-size:20px">Plan săptămânal</h3>
              <div class="days" id="days"></div>
            </div>
            <div id="menuWrap">
              <div class="hint">Completează preferințele și apasă <strong>Generează meniul</strong>.</div>
            </div>
          </div>
          <div class="card pad">
            <h3 style="margin:0 0 8px;font-size:20px">Listă de cumpărături</h3>
            <p class="hint" style="margin-top:0">Se calculează automat după generarea meniului.</p>
            <div id="listCumparaturi" class="chips"></div>
          </div>
        </section>

        <section class="section card pad" id="abonament">
          <h3 style="margin:0 0 8px;font-size:20px">Abonament AI Nutriție PRO</h3>
          <p class="hint" style="margin-top:0">Pentru cei care <strong>nu sunt clienți</strong> ai serviciilor la domiciliu și vor să genereze meniuri personalizate.</p>
          <ul style="margin:0 0 12px 18px">
            <li>Generări nelimitate de meniuri</li>
            <li>Export PDF & trimitere e‑mail</li>
            <li>Listă de cumpărături automată</li>
          </ul>
          <div class="actions">
            <a class="btn btn-primary" href="pachete_nutritie.html" onclick="return goSubscribe(this)">Activează abonamentul</a>
            <button class="btn btn-ghost" onclick="prefillAccess('SUB-')">Am cod SUB‑</button>
          </div>
        </section>
      </div>

      <!-- TAB: EXPERT -->
      <div id="tab-expert">
        <section class="section card pad">
          <h3 style="margin:0 0 12px;font-size:20px">Vorbește cu un nutriționist</h3>
          <p>Completează datele, iar echipa noastră te contactează pentru o consultație (online sau la domiciliu, în funcție de oraș).</p>
          <div class="grid grid-2">
            <div>
              <label for="exNume">Nume</label>
              <input id="exNume" placeholder="Nume și prenume" />
            </div>
            <div>
              <label for="exEmail">Email</label>
              <input id="exEmail" type="email" placeholder="prenume@exemplu.com" />
            </div>
            <div>
              <label for="exTel">Telefon</label>
              <input id="exTel" placeholder="07xx xxx xxx" />
            </div>
            <div>
              <label for="exOras">Oraș</label>
              <input id="exOras" placeholder="Ex: București / Milano" />
            </div>
            <div class="grid" style="grid-template-columns:1fr">
              <label for="exDetalii">Obiectiv & detalii</label>
              <textarea id="exDetalii" placeholder="Ex: scădere în greutate, meniu pentru diabet, intoleranță lactoză..." ></textarea>
            </div>
          </div>
          <div class="actions" style="margin-top:12px">
            <button class="btn btn-primary" onclick="toast('Cererea a fost trimisă. Revenim în scurt timp.')">Programează consultanță</button>
            <button class="btn btn-ghost" onclick="document.querySelector('[data-tab=ai]').click()">Revino la AI</button>
          </div>
        </section>

        <!-- TABEL MUTAT AICI: vizualizare plan în tabul Expert -->
        <section class="section card pad">
          <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:8px">
            <h3 style="margin:0;font-size:20px">Plan săptămânal (vizualizare)</h3>
            <div class="days" id="daysExpert"></div>
          </div>
          <div id="menuWrapExpert">
            <div class="hint">Generează un meniu din tab‑ul <strong>AI rapid</strong> sau solicită consultanță, iar nutriționistul nostru îl va configura pentru tine.</div>
          </div>
          <div class="actions" style="margin-top:12px">
            <button class="btn btn-primary" onclick="document.querySelector('[data-tab=ai]').click(); window.scrollTo({top: document.querySelector('#tab-ai').offsetTop-60, behavior:'smooth'})">Generează cu AI</button>
          </div>
        </section>

        <section class="section card pad faq">
          <h3 style="margin:0 0 8px;font-size:20px">Întrebări frecvente</h3>
          <details>
            <summary><strong>Este acesta un sfat medical?</strong></summary>
            <p>Nu. Conținutul are scop informativ și nu înlocuiește recomandările unui medic sau dietetician. Pentru afecțiuni sau nevoi speciale, alege tab‑ul „Consultă un nutriționist”.</p>
          </details>
          <details>
            <summary><strong>Ce tipuri de acces există?</strong></summary>
            <p><strong>Abonament SUB‑</strong>: pentru cei care nu sunt clienți și doresc generări nelimitate + PDF + e‑mail. <br> <strong>Cod client</strong> (BP8/BP12/BP20): rămâne valabil pentru clienții existenți. Ambele deblochează funcțiile PRO.</p>
          </details>
        </section>
      </div>
    </div>

    <footer>
      © <span id="year"></span> Bucătarul Personal · AI Nutriție. Toate drepturile rezervate. — <em>Acest conținut are rol informativ și nu substituie consultul medical.</em>
    </footer>
  </main>

  <div class="toast" id="toast"></div>

  <script>
    // ---------- Utilities ----------
    const $ = (s, root=document) => root.querySelector(s);
    const $$ = (s, root=document) => [...root.querySelectorAll(s)];
    const fmt = n => (Math.round(n*10)/10).toLocaleString('ro-RO');

    function toast(msg, type){
      const t = $('#toast');
      t.textContent = msg; 
      t.classList.toggle('error', type==='error');
      t.classList.add('show');
      setTimeout(()=>t.classList.remove('show'), 2600);
    }

    // ---------- Validation helpers ----------
    const RE_EMAIL = /^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/i;
    const RE_TEL = /^(\+?\d{7,15}|0\d{9,10})$/;
    function setFieldError(el,msg){
      if(!el) return false;
      let m = document.getElementById(el.id+"_err");
      if(!m){ m = document.createElement('div'); m.id=el.id+"_err"; m.className='field-msg'; el.insertAdjacentElement('afterend', m); }
      m.textContent = msg; m.classList.add('show'); el.classList.add('input-error'); el.setAttribute('aria-invalid','true');
      return false;
    }
    function clearFieldError(el){ if(!el) return; const m=$('#'+el.id+"_err"); if(m) m.classList.remove('show'); el.classList.remove('input-error'); el.removeAttribute('aria-invalid'); }
    function validateEmailField(){ const el=$('#email'); if(!el) return true; clearFieldError(el); const v=(el.value||'').trim(); if(v && !RE_EMAIL.test(v)) return setFieldError(el,'Email invalid'); return true; }
    function validatePhoneField(){ const el=$('#telefon'); if(!el) return true; clearFieldError(el); const v=(el.value||'').trim(); if(v && !RE_TEL.test(v)) return setFieldError(el,'Telefon invalid'); return true; }

    // live validation
    ['blur','input'].forEach(evt=>{
      const e = $('#email'); const t = $('#telefon');
      if(e) e.addEventListener(evt, validateEmailField);
      if(t) t.addEventListener(evt, validatePhoneField);
    });

    // ---------- Access / PRO & Demo limiter ----------
    let HAS_PRO = false;
    function updateDemoCounterUI(data){
      const el = $('#demoCounter');
      if(!el) return; 
      if(HAS_PRO){ el.style.display='none'; return; }
      const today = new Date().toISOString().slice(0,10);
      if(!data || data.date!==today) data = {date:today,count:0};
      el.textContent = `Demo: ${Math.max(0, 3 - (data.count||0))} generări rămase azi`;
      el.style.display='inline-flex';
    }
    function getDemoData(){
      try{ return JSON.parse(localStorage.getItem('bp_demo')||'{}'); }catch(e){ return {}; }
    }
    function setDemoData(d){ localStorage.setItem('bp_demo', JSON.stringify(d)); }
    function canGenerateDemo(){
      if(HAS_PRO) return true;
      const today = new Date().toISOString().slice(0,10);
      let d = getDemoData();
      if(d.date!==today) d={date:today,count:0};
      if(d.count>=3){ toast('Limită atinsă: 3 meniuri/zi fără abonament. Activează SUB‑ pentru nelimitat.', 'error'); return false; }
      d.count++; setDemoData(d); updateDemoCounterUI(d); return true;
    }

    function checkAccess(){
      const v = $('#accessCode') ? $('#accessCode').value.trim().toUpperCase() : '';
      HAS_PRO = /^(SUB-|BP8-|BP12-|BP20-)[A-Z0-9]{3,}$/i.test(v);
      if($('#accessStatus')){
        $('#accessStatus').className = 'status ' + (HAS_PRO? 'ok':'warn');
        $('#accessStatus').textContent = HAS_PRO ? 'PRO activ – export & email deblocate' : 'Acces standard – funcții PRO blocate';
      }
      if($('#btnPdf')) $('#btnPdf').disabled = !HAS_PRO; 
      if($('#btnMail')) $('#btnMail').disabled = !HAS_PRO;
      updateDemoCounterUI(getDemoData());
      if(HAS_PRO) toast('Beneficii PRO activate.');
      localStorage.setItem('bp_access', v);
      return HAS_PRO;
    }
    function prefillAccess(prefix){
      const rnd = Math.random().toString(36).slice(2,6).toUpperCase();
      if($('#accessCode')) $('#accessCode').value = prefix + rnd; 
      checkAccess();
      window.scrollTo({top:0,behavior:'smooth'});
    }
    // Preload from URL or storage
    (function(){
      const url = new URL(location.href);
      const q = url.searchParams.get('access') || localStorage.getItem('bp_access') || '';
      if(q && $('#accessCode')){ $('#accessCode').value = q; checkAccess(); }
      const heroParam = url.searchParams.get('hero');
      if(heroParam){ document.documentElement.style.setProperty('--hero-img', "url('"+heroParam+"')"); }
      const today = new Date().toISOString().slice(0,10);
      let d = getDemoData(); if(d.date!==today){ d={date:today,count:0}; setDemoData(d); }
      updateDemoCounterUI(d);
      const y = $('#year'); if(y) y.textContent = new Date().getFullYear();
    })();

    // ---------- Tabs (robust + deep-link, SAFE in sandbox) ----------
    function safeHashUpdate(name){
      // Avoid SecurityError in about:srcdoc or sandboxed iframes
      try{
        const href = (location && location.href) || '';
        if(href && !href.startsWith('about:') && history && typeof history.replaceState==='function'){
          history.replaceState(null,'', (location.pathname||'') + (location.search||'') + '#' + name);
        }
      }catch(e){ /* noop in sandbox */ }
    }
    function switchTab(name){
      const targetId = 'tab-' + name;
      const tabBtns = $$('.tab');
      const panes = $$('.tabpanes > div');
      if(!panes.length || !tabBtns.length) return;
      tabBtns.forEach(b=>b.classList.toggle('active', b.dataset.tab===name));
      panes.forEach(p=>p.classList.toggle('active', p.id===targetId));
      safeHashUpdate(name);
    }
    $$('.tab').forEach(btn=>{ btn.addEventListener('click',()=> switchTab(btn.dataset.tab)); });
    (function(){
      const url = new URL(location.href);
      const qtab = url.searchParams.get('tab') || location.hash.replace('#','');
      if(qtab && ['ai','expert'].includes(qtab)) switchTab(qtab); else switchTab('ai');
    })();

    // ---------- Recipe library (simplificat) ----------
    const LIB = {
      breakfast:[
        {n:'Omletă cu spanac și feta', kcal:420, p:30, c:6, f:28, ing:{oua:3, spanac:80, branza_feta:40, ulei:8}},
        {n:'Iaurt grecesc cu granola & fructe', kcal:380, p:25, c:45, f:10, ing:{iaurt_grecesc:200, granola:45, fructe:120}},
        {n:'Terci ovăz proteic', kcal:430, p:32, c:55, f:12, ing:{ovaz:70, lapte:250, pudra_proteica:30, banana:100}},
      ],
      lunch:[
        {n:'Piept de pui cu orez basmati & legume', kcal:650, p:55, c:65, f:16, ing:{pui:180, orez:80, legume:200, ulei:10}},
        {n:'Somon la cuptor cu cartofi & salată', kcal:700, p:45, c:50, f:34, ing:{somon:170, cartofi:250, salata:120, ulei:10}},
        {n:'Pasta integrale cu ton & roșii', kcal:620, p:38, c:78, f:16, ing:{paste:90, ton:120, rosii:150, ulei:8}}
      ],
      dinner:[
        {n:'Curcan cu quinoa & legume', kcal:600, p:48, c:54, f:18, ing:{curcan:160, quinoa:70, legume:200, ulei:8}},
        {n:'Tocană vegană de linte', kcal:560, p:30, c:74, f:16, ing:{linte:120, legume:220, ulei:10}},
        {n:'Halloumi la grătar cu tabbouleh', kcal:580, p:32, c:60, f:22, ing:{halloumi:140, cuscus:80, patrunjel:30, ulei:10}}
      ],
      snack:[
        {n:'Brânză cottage cu fructe de pădure', kcal:220, p:24, c:20, f:6, ing:{cottage:200, fructe:120}},
        {n:'Hummus cu bastonașe de legume', kcal:260, p:10, c:26, f:12, ing:{hummus:120, legume:180}},
        {n:'Nuci & măr', kcal:240, p:6, c:22, f:16, ing:{nuci:25, mar:160}}
      ]
    };

    const DAYS = ['Luni','Marți','Miercuri','Joi','Vineri','Sâmbătă','Duminică'];
    let PLAN = null; // va conține meniul generat

    // ---------- Generation ----------
    function rand(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
    function scaleMeal(meal, targetKcal){
      const s = Math.max(0.6, Math.min(1.7, targetKcal / meal.kcal));
      return {
        n: meal.n + (Math.abs(1-s) > 0.12 ? ` (×${fmt(s)})` : ''),
        kcal: meal.kcal*s, p: meal.p*s, c: meal.c*s, f: meal.f*s,
        ing: Object.fromEntries(Object.entries(meal.ing).map(([k,v])=>[k, v*s]))
      };
    }
    function totals(meals){
      return meals.reduce((a,m)=>({kcal:a.kcal+m.kcal, p:a.p+m.p, c:a.c+m.c, f:a.f+m.f}),{kcal:0,p:0,c:0,f:0});
    }

    function generate(){
      if(!canGenerateDemo()) return;
      const kcalDay = parseInt($('#kcal').value,10);
      const protDay = parseInt($('#proteine').value || 0,10) || Math.round(kcalDay*0.25/4); // ~25% din kcal în proteine
      const mealsCount = parseInt($('#mese').value,10);

      // simple allergy/avoid filters (by keywords)
      const avoid = ($('#alergii').value + ',' + $('#evita').value).toLowerCase();
      const filterMeal = (m) => {
        const words = Object.keys(m.ing).join(' ')+ ' ' + m.n;
        return !avoid || !avoid.split(',').some(w=>w.trim() && words.toLowerCase().includes(w.trim()))
      };

      // Build a 7-day plan
      PLAN = DAYS.map((d)=>{
        const dayMeals = [];
        const pick = (bucket) => {
          let options = LIB[bucket].filter(filterMeal);
          if(options.length===0) options = LIB[bucket];
          return rand(options);
        };
        if(mealsCount===3){
          dayMeals.push(scaleMeal(pick('breakfast'), kcalDay*0.30));
          dayMeals.push(scaleMeal(pick('lunch'),     kcalDay*0.45));
          dayMeals.push(scaleMeal(pick('dinner'),    kcalDay*0.25));
        } else if(mealsCount===4){
          dayMeals.push(scaleMeal(pick('breakfast'), kcalDay*0.25));
          dayMeals.push(scaleMeal(pick('lunch'),     kcalDay*0.35));
          dayMeals.push(scaleMeal(pick('dinner'),    kcalDay*0.30));
          dayMeals.push(scaleMeal(pick('snack'),     kcalDay*0.10));
        } else {
          // 5 mese: mic dejun + pranz + cina + 2 gustari
          dayMeals.push(scaleMeal(pick('breakfast'), kcalDay*0.22));
          dayMeals.push(scaleMeal(pick('lunch'),     kcalDay*0.33));
          dayMeals.push(scaleMeal(pick('dinner'),    kcalDay*0.27));
          dayMeals.push(scaleMeal(pick('snack'),     kcalDay*0.09));
          dayMeals.push(scaleMeal(pick('snack'),     kcalDay*0.09));
        }
        const t = totals(dayMeals);
        const pDelta = protDay ? (t.p - protDay) : 0;
        return { day:d, meals:dayMeals, total:t, protTarget:protDay, protDelta:pDelta };
      });

      renderAllDays();
      renderDay(0); renderDay(0,'Expert');
      renderShoppingList();
      toast('Meniul a fost generat.');
    }

    // ---------- Render (generalizat pentru AI & Expert) ----------
    function renderAllDays(){ renderDays(''); renderDays('Expert'); }
    function renderDays(suffix=''){
      const wrap = document.getElementById('days'+suffix);
      if(!wrap || !PLAN) return;
      wrap.innerHTML = '';
      PLAN.forEach((d,i)=>{
        const b = document.createElement('button');
        b.className = 'day' + (i===0?' active':'');
        b.textContent = d.day;
        b.addEventListener('click',()=>{ $$('.day',wrap).forEach(x=>x.classList.remove('active')); b.classList.add('active'); renderDay(i,suffix); });
        wrap.appendChild(b);
      });
    }

    function renderDay(idx, suffix=''){
      const D = PLAN && PLAN[idx];
      const host = document.getElementById('menuWrap'+suffix);
      if(!host){ return; }
      if(!D){ host.innerHTML = '<div class="hint">Nu există încă un plan. Generează unul din tab‑ul <strong>AI rapid</strong>.</div>'; return; }
      let html = `<div class="hint" style="margin-bottom:10px">Țintă proteine: <strong>${fmt(D.protTarget)}</strong> g — realizat: <strong>${fmt(D.total.p)}</strong> g (${D.total.p >= D.protTarget ? '✅' : 'ℹ️ ajustează porțiile'})</div>`;
      html += '<table><thead><tr><th>Masa</th><th>Preparat</th><th>kcal</th><th>Prot</th><th>Carb</th><th>Grăs</th></tr></thead><tbody>';
      const slots = D.meals.length===3?['Mic dejun','Prânz','Cină']:(D.meals.length===4?['Mic dejun','Prânz','Cină','Gustare']:["Mic dejun","Prânz","Cină","Gustare 1","Gustare 2"]);
      D.meals.forEach((m,i)=>{
        html += `<tr><td>${slots[i]}</td><td>${m.n}</td><td>${fmt(m.kcal)}</td><td>${fmt(m.p)}</td><td>${fmt(m.c)}</td><td>${fmt(m.f)}</td></tr>`
      });
      html += `</tbody><tfoot><tr><td colspan="2">Total zilnic</td><td>${fmt(D.total.kcal)}</td><td>${fmt(D.total.p)}</td><td>${fmt(D.total.c)}</td><td>${fmt(D.total.f)}</td></tr></tfoot></table>`;
      host.innerHTML = html;
    }

    function renderShoppingList(){
      const acc = {};
      if(!PLAN) return;
      PLAN.forEach(D=>D.meals.forEach(m=>{
        Object.entries(m.ing).forEach(([k,v])=>{ acc[k] = (acc[k]||0) + v; });
      }));
      const wrap = $('#listCumparaturi');
      if(!wrap) return;
      wrap.innerHTML = '';
      Object.entries(acc).sort((a,b)=>a[0].localeCompare(b[0])).forEach(([k,v])=>{
        const div = document.createElement('div');
        div.className = 'chip';
        const unit = ['oua','nuci'].includes(k) ? 'buc' : 'g';
        div.textContent = `${k.replaceAll('_',' ')} — ${Math.round(v)} ${unit}`;
        wrap.appendChild(div);
      });
    }

    // ---------- Subscribe redirect ----------
    const SUBSCRIBE_URL = '/checkout/ai-pro';
    function goSubscribe(el){
      const prefix='SUB-';
      const rnd = Math.random().toString(36).slice(2,6).toUpperCase();
      const code = prefix + rnd;
      if($('#accessCode')) $('#accessCode').value = code;
      checkAccess();
      const base = (el && el.getAttribute('href')) || SUBSCRIBE_URL;
      const dest = base + (base.includes('?')?'&':'?') + 'access=' + encodeURIComponent(code);
      window.location.href = dest;
      return false;
    }

    // ---------- PDF & Email (client-side) ----------
    function exportPdf(){ window.print(); }
    async function sendEmail(){
      if(!HAS_PRO){ toast('Funcție disponibilă doar pentru PRO.', 'error'); return; }
      const emailOk = validateEmailField();
      const emailVal = ($('#email')?$('#email').value:'').trim();
      if(!emailOk || !emailVal){ setFieldError($('#email'), 'Adaugă un email valid pentru trimitere.'); toast('Email invalid.', 'error'); return; }
      const mailBtn = $('#btnMail');
      const oldTxt = mailBtn.textContent; mailBtn.disabled = true; mailBtn.textContent = 'Se trimite...';
      const payload = {
        nume: $('#nume')?$('#nume').value:'', email: emailVal, telefon: $('#telefon')?$('#telefon').value:'', oras: $('#oras')?$('#oras').value:'',
        kcal: $('#kcal')?$('#kcal').value:'', proteine: $('#proteine')?$('#proteine').value:'', mese: $('#mese')?$('#mese').value:'', alergii: $('#alergii')?$('#alergii').value:'',
        plan: PLAN
      };
      try{
        const res = await fetch('/api/send_menu_pdf.php', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
        if(res.ok){ toast('Meniul a fost trimis pe e‑mail.'); }
        else { toast('Nu s-a putut trimite: server indisponibil (HTTP '+res.status+').', 'error'); }
      }catch(e){ toast('Eroare rețea/endpoint: nu s-a putut trimite meniul.', 'error'); }
      finally{ mailBtn.disabled=false; mailBtn.textContent = oldTxt; }
    }

    // ---------- Events ----------
    const gBtn=$('#btnGen'); if(gBtn) gBtn.addEventListener('click', generate);
    const pBtn=$('#btnPdf'); if(pBtn) pBtn.addEventListener('click', exportPdf);
    const mBtn=$('#btnMail'); if(mBtn) mBtn.addEventListener('click', sendEmail);

    // ---------- SELF TESTS (rulează doar cu ?test=1) ----------
    (function selfTests(){
      const url = new URL(location.href);
      if(url.searchParams.get('test') !== '1') return;
      const results = [];
      try{
        console.assert(typeof prefillAccess === 'function', 'prefillAccess trebuie să existe');
        prefillAccess('SUB-');
        const code = $('#accessCode').value;
        console.assert(/^SUB-[A-Z0-9]{4}$/.test(code), 'cod SUB- generat corect');
        console.assert(checkAccess() === true, 'checkAccess activează PRO');
        // Limiter tests
        HAS_PRO = false; localStorage.setItem('bp_demo', JSON.stringify({date:new Date().toISOString().slice(0,10),count:3}));
        console.assert(canGenerateDemo() === false, 'limiter blochează peste 3/zi fără PRO');
        localStorage.setItem('bp_demo', JSON.stringify({date:new Date().toISOString().slice(0,10),count:0}));
        console.assert(canGenerateDemo() === true, 'limiter permite sub 3/zi');
        // Tabs safety test (no throw in sandbox)
        switchTab('expert');
        console.assert(document.getElementById('tab-expert').classList.contains('active'), 'switchTab activează expert');
        switchTab('ai');
        console.assert(document.getElementById('tab-ai').classList.contains('active'), 'switchTab revine la ai');
        results.push('✔︎ Tests OK');
      }catch(e){ results.push('✗ Test failed: '+ e.message); }
      toast(results.join(' | '));
      console.log('[SELF TESTS]', results);
    })();
  </script>
</body>
</html>

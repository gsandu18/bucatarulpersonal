<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard Bucătar – Cereri, Chat & VideoCall | Bucătarul Personal</title>
  <meta name="description" content="Dashboard pentru bucătar: cereri alocate, chat cu clientul și video call direct în browser. Include date profil și cont bancar." />
  <meta name="theme-color" content="#0e5a43" />

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />

  <style>
    :root{ --rubin:#0e5a43; --rubin-2:#0b4a36; --negru:#0b0f12; --alb:#fff; --gri-1:#f5f7f8; --gri-2:#e8ecee; --gri-3:#cfd6da; --text:#1c2226; --shadow:0 16px 48px rgba(0,0,0,.14); --radius-xl:22px; --radius-lg:16px; --radius-md:12px }
    *{box-sizing:border-box}
    html,body{margin:0}
    body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:var(--text);background:#fff;line-height:1.5}
    a{color:inherit;text-decoration:none}
    img{max-width:100%;display:block}
    .container{width:min(1160px,92%);margin:0 auto}

    /* Header (prefix chef-) */
    header{position:sticky;top:0;z-index:40;background:rgba(255,255,255,.85);backdrop-filter:blur(10px);border-bottom:1px solid var(--gri-2)}
    .chef-nav{display:flex;align-items:center;justify-content:space-between;padding:12px 0}
    .chef-brand{display:flex;gap:10px;align-items:center}
    .chef-brand img{height:46px}
    .chef-links{display:flex;gap:18px;align-items:center}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:999px;border:1px solid var(--gri-3);background:#fff;font-weight:700;cursor:pointer}
    .btn-primary{background:var(--rubin);color:#fff;border-color:transparent}
    .btn-ghost{background:#fff}
    .chef-burger{display:none;width:42px;height:42px;border-radius:12px;border:1px solid var(--gri-3);align-items:center;justify-content:center}
    @media (max-width:980px){.chef-links{display:none}.chef-burger{display:flex}}
    .chef-mobile{position:fixed;inset:0;background:rgba(0,0,0,.45);backdrop-filter:blur(3px);display:none}
    .chef-mobile.active{display:block}
    .chef-sheet{position:absolute;right:0;top:0;height:100%;width:min(420px,92%);background:#fff;padding:20px;box-shadow:var(--shadow);display:flex;flex-direction:column;gap:10px}
    .chef-sheet a{padding:12px 8px;border-bottom:1px solid var(--gri-2);font-weight:700}

    /* Layout */
    main{padding:28px 0}
    .grid{display:grid;grid-template-columns:320px 1fr;gap:22px}
    @media (max-width:980px){.grid{grid-template-columns:1fr}}

    /* Carduri */
    .card{background:#fff;border:1px solid var(--gri-2);border-radius:var(--radius-xl);box-shadow:var(--shadow)}
    .card .body{padding:18px}
    .split{display:flex;align-items:center;justify-content:space-between;gap:10px}

    /* Sidebar profil bucătar */
    .profile{display:flex;flex-direction:column;gap:14px}
    .avatar{width:112px;height:112px;border-radius:50%;overflow:hidden;border:3px solid #fff;box-shadow:0 8px 20px rgba(0,0,0,.2)}
    .avatar img{width:100%;height:100%;object-fit:cover}
    .pill{display:inline-flex;gap:8px;align-items:center;padding:6px 10px;border-radius:999px;border:1px solid var(--gri-3);font-size:12px}
    .kv{display:grid;grid-template-columns:1fr;gap:8px}
    .kv label{font-size:12px;color:#5b6870}

    /* Cereri + Chat */
    .work{display:grid;grid-template-columns:1fr 1.2fr;gap:18px}
    @media (max-width:1180px){.work{grid-template-columns:1fr}}

    .req-list{display:grid;gap:12px}
    .req{border:1px solid var(--gri-2);border-radius:16px;padding:12px}
    .req .top{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .status{font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid var(--gri-3)}
    .status.new{background:#fff6e5;border-color:#f3d6a3}
    .status.talk{background:#eaf6ff;border-color:#bcdfff}
    .status.ok{background:#e9fbef;border-color:#b8ebc7}

    /* Chat */
    .chat{border:1px solid var(--gri-2);border-radius:16px;display:flex;flex-direction:column;min-height:420px}
    .chat-head{padding:12px 14px;border-bottom:1px solid var(--gri-2);display:flex;align-items:center;gap:10px}
    .chat-body{padding:14px;flex:1;overflow:auto;background:var(--gri-1)}
    .msg{max-width:78%;margin:6px 0;padding:10px 12px;border-radius:14px;border:1px solid var(--gri-2);background:#fff;box-shadow:0 2px 10px rgba(0,0,0,.04)}
    .msg.me{margin-left:auto;background:#f0f6f3;border-color:#cde7d8}
    .msg .meta{font-size:11px;color:#6a757c;margin-top:6px}
    .chat-foot{padding:12px 14px;border-top:1px solid var(--gri-2);display:flex;gap:8px}
    .chat-foot textarea{flex:1;padding:10px 12px;border-radius:12px;border:1px solid var(--gri-3);background:#fbfcfc;min-height:42px;resize:vertical}

    /* Dialog generic */
    .dialog{position:fixed;inset:0;background:rgba(0,0,0,.45);backdrop-filter:blur(3px);display:none;align-items:center;justify-content:center;padding:16px;z-index:60}
    .dialog.active{display:flex}
    .dialog .panel{width:min(720px,96%);background:#fff;border:1px solid var(--gri-2);border-radius:18px;box-shadow:var(--shadow)}
    .dialog .panel .body{display:grid;gap:12px}
    .row{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
    @media (max-width:640px){.row{grid-template-columns:1fr}}
    label{font-weight:700;font-size:13px;color:#34424a}
    input, select, textarea{width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--gri-3);background:#fbfcfc}

    /* Videocall modal */
    .vmodal{position:fixed;inset:0;background:rgba(0,0,0,.5);backdrop-filter:blur(3px);display:none;align-items:center;justify-content:center;padding:16px;z-index:70}
    .vmodal.active{display:flex}
    .vmodal .panel{width:min(1100px,98%);height:min(88vh,900px);background:#0a0d0f;border:1px solid #1e252a;border-radius:18px;box-shadow:0 20px 60px rgba(0,0,0,.45);display:flex;flex-direction:column}
    .v-head{padding:10px 12px;border-bottom:1px solid #1e252a;display:flex;align-items:center;gap:10px;color:#eaf5ef}
    .v-body{flex:1}
    .v-foot{padding:10px 12px;border-top:1px solid #1e252a;display:flex;gap:8px;justify-content:flex-end}

    /* Footer */
    footer{background:var(--negru);color:#cdd6dc;padding:32px 0;margin-top:32px}
    .foot-grid{display:grid;grid-template-columns:2fr 1fr 1fr 1fr;gap:18px}
    @media(max-width:980px){.foot-grid{grid-template-columns:1fr 1fr}}
    @media(max-width:640px){.foot-grid{grid-template-columns:1fr}}
    .legal{border-top:1px solid #2c353b;margin-top:14px;padding-top:10px;font-size:13px;color:#99a5ad}
  </style>
</head>
<body>
  <!-- Header -->
  <header>
    <div class="container chef-nav">
      <a class="chef-brand" href="/" aria-label="Acasă">
        <img src="/static/logo-bucatarul-personal.png" alt="Bucătarul Personal – logo" />
        <strong>Bucătarul Personal</strong>
      </a>
      <nav class="chef-links" aria-label="Navigație">
        <a href="/bucatarii.html">Bucătari</a>
        <a href="/servicii.html">Servicii</a>
        <a href="/contact.html">Contact</a>
        <a class="btn btn-primary" href="/contul_meu"><i class="fa-solid fa-user"></i> Contul meu</a>
      </nav>
      <button id="chef-burger" class="chef-burger" aria-label="Deschide meniul"><i class="fa-solid fa-bars"></i></button>
    </div>
    <div id="chef-mobile" class="chef-mobile" aria-hidden="true">
      <div class="chef-sheet" role="dialog" aria-modal="true" aria-label="Meniu">
        <div class="split">
          <strong>Meniu</strong>
          <button id="chef-close" class="btn"><i class="fa-solid fa-xmark"></i> Închide</button>
        </div>
        <a href="/bucatarii.html">Bucătari</a>
        <a href="/servicii.html">Servicii</a>
        <a href="/contact.html">Contact</a>
        <a class="btn" href="/contul_meu"><i class="fa-solid fa-user"></i> Contul meu</a>
      </div>
    </div>
  </header>

  <main class="container">
    <div class="grid">
      <!-- Sidebar profil bucătar -->
      <aside>
        <div class="card">
          <div class="body profile">
            <div class="avatar"><img id="chef-avatar" src="https://images.unsplash.com/photo-1500648767791-00dcc994a43e?q=80&w=400&auto=format&fit=crop" alt="Avatar chef"></div>
            <div>
              <strong id="chef-name" style="font-size:18px">Chef</strong>
              <div class="pill" title="Disponibilitate"><i class="fa-solid fa-calendar-check"></i> <span id="chef-status">Disponibil</span></div>
            </div>
            <div class="kv">
              <div><label>Email</label><div id="chef-email">chef@exemplu.ro</div></div>
              <div><label>Telefon</label><div id="chef-phone">+40 7xx xxx xxx</div></div>
              <div><label>Oraș</label><div id="chef-city">București</div></div>
              <div><label>Cont bancar (IBAN)</label><div id="chef-iban">RO49AAAA1B31007593840000</div></div>
            </div>
            <div class="split">
              <button id="chef-edit" class="btn"><i class="fa-solid fa-pen"></i> Editează</button>
            </div>
          </div>
        </div>
      </aside>

      <!-- Cereri + Chat -->
      <section class="work">
        <div>
          <div class="split" style="margin-bottom:8px">
            <h2 style="margin:0">Cererile mele alocate</h2>
            <div class="pill"><i class="fa-solid fa-circle-info"></i> Selectează o cerere pentru chat/video</div>
          </div>
          <div id="chef-req-list" class="req-list"></div>
        </div>

        <div>
          <div class="chat">
            <div class="chat-head">
              <div style="display:flex;align-items:center;gap:10px">
                <div class="avatar" style="width:38px;height:38px;border-width:2px"><img id="chef-chat-client-avatar" src="https://images.unsplash.com/photo-1544005313-94ddf0286df2?q=80&w=200&auto=format&fit=crop" alt="Client avatar"></div>
                <div>
                  <div id="chef-chat-client-name" style="font-weight:800">Alege o cerere</div>
                  <div id="chef-chat-req-meta" style="font-size:12px;color:#6b777e">—</div>
                </div>
              </div>
              <div style="margin-left:auto;display:flex;gap:8px">
                <a id="chef-chat-wa" class="btn" href="#" target="_blank" rel="noopener" title="WhatsApp client"><i class="fa-brands fa-whatsapp"></i></a>
                <button id="chef-video" class="btn" disabled title="VideoCall"><i class="fa-solid fa-video"></i> Video</button>
                <button id="chef-export" class="btn"><i class="fa-solid fa-file-arrow-down"></i> Export</button>
              </div>
            </div>
            <div id="chef-chat" class="chat-body"></div>
            <div class="chat-foot">
              <textarea id="chef-input" placeholder="Scrie un mesaj pentru client…" disabled></textarea>
              <button id="chef-send" class="btn btn-primary" disabled><i class="fa-solid fa-paper-plane"></i> Trimite</button>
            </div>
          </div>
        </div>
      </section>
    </div>
  </main>

  <!-- Dialog Edit profil / Vizualizare cerere -->
  <div id="chef-dialog" class="dialog" aria-hidden="true">
    <div class="panel">
      <div class="body">
        <div class="split"><strong id="chef-dialog-title">Editează profil</strong><button id="chef-dialog-x" class="btn"><i class="fa-solid fa-xmark"></i> Închide</button></div>
        <form id="chef-form" class="form" onsubmit="return false">
          <div id="chef-form-profile">
            <div class="row">
              <div><label>Nume</label><input id="c-name" required></div>
              <div><label>Oraș</label><input id="c-city"></div>
            </div>
            <div class="row">
              <div><label>Email</label><input id="c-email" type="email"></div>
              <div><label>Telefon</label><input id="c-phone"></div>
            </div>
            <div class="row">
              <div><label>IBAN</label><input id="c-iban"></div>
              <div><label>Avatar (URL)</label><input id="c-avatar" placeholder="https://…"></div>
            </div>
          </div>

          <div id="chef-form-view" style="display:none">
            <div class="row">
              <div><label>ID cerere</label><input id="v-id" disabled></div>
              <div><label>Data</label><input id="v-date" disabled></div>
            </div>
            <div class="row">
              <div><label>Oraș</label><input id="v-city" disabled></div>
              <div><label>Nr. persoane</label><input id="v-persons" disabled></div>
            </div>
            <div class="row">
              <div><label>Buget</label><input id="v-budget" disabled></div>
              <div><label>Client</label><input id="v-client" disabled></div>
            </div>
            <div><label>Note</label><textarea id="v-notes" disabled></textarea></div>
          </div>

          <div class="split">
            <div id="chef-form-hint" class="pill">—</div>
            <button id="chef-save" class="btn btn-primary"><i class="fa-solid fa-floppy-disk"></i> Salvează</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Videocall modal -->
  <div id="chef-vmodal" class="vmodal" aria-hidden="true">
    <div class="panel">
      <div class="v-head">
        <strong><i class="fa-solid fa-video"></i> VideoCall cu clientul</strong>
        <span id="chef-vtitle" style="opacity:.85;margin-left:8px"></span>
        <button id="chef-vcopy" class="btn" style="margin-left:auto"><i class="fa-solid fa-link"></i> Copiază link</button>
        <button id="chef-vclose" class="btn"><i class="fa-solid fa-xmark"></i> Închide</button>
      </div>
      <div id="chef-jitsi" class="v-body"></div>
      <div class="v-foot">
        <small style="color:#aab7bf">Permite accesul la cameră și microfon pentru apel.</small>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer>
    <div class="container foot-grid">
      <div>
        <div style="display:flex;align-items:center;gap:12px"><img src="/static/logo-bucatarul-personal.png" alt="Bucătarul Personal – logo" style="height:46px" /><strong style="color:#eaf5ef">Bucătarul Personal</strong></div>
        <p style="color:#b7c2c8;margin:10px 0 0">Instrumente pentru bucătari: gestionează cereri, discută cu clienții și programează apeluri video.</p>
      </div>
      <div>
        <strong style="color:#eaf5ef">Companie</strong>
        <ul style="list-style:none;padding:0;margin:10px 0 0;display:grid;gap:8px">
          <li><a href="/despre-noi.html">Despre noi</a></li>
          <li><a href="/servicii.html">Servicii</a></li>
          <li><a href="/bucatarii.html">Bucătari</a></li>
          <li><a href="/testimoniale.html">Testimoniale</a></li>
        </ul>
      </div>
      <div>
        <strong style="color:#eaf5ef">Legal</strong>
        <ul style="list-style:none;padding:0;margin:10px 0 0;display:grid;gap:8px">
          <li><a href="#">Termeni & Condiții</a></li>
          <li><a href="#">Politica de confidențialitate</a></li>
          <li><a href="#">Cookies</a></li>
        </ul>
      </div>
      <div>
        <strong style="color:#eaf5ef">Contact rapid</strong>
        <div style="display:flex;gap:10px;margin-top:10px;align-items:center">
          <a href="https://wa.me/40772893476" target="_blank" rel="noopener" aria-label="WhatsApp"><i class="fa-brands fa-whatsapp"></i> 0772 893 476</a>
        </div>
      </div>
    </div>
    <div class="container legal">© <span id="chef-year"></span> Bucătarul Personal — Toate drepturile rezervate.</div>
  </footer>

  <!-- WhatsApp floating CTA -->
  <a href="https://wa.me/40772893476" target="_blank" rel="noopener" aria-label="Scrie pe WhatsApp" style="position:fixed;right:18px;bottom:18px;width:54px;height:54px;border-radius:50%;background:#25D366;color:#fff;display:grid;place-items:center;box-shadow:0 10px 24px rgba(0,0,0,.18);z-index:80"><i class="fa-brands fa-whatsapp" style="font-size:24px"></i></a>

  <script>
    // Tot JS izolat (prefix chef-) ca să evităm coliziuni și redeclarări
    (()=>{
      const $ = (s, r=document)=> r.querySelector(s);
      const $$ = (s, r=document)=> Array.from(r.querySelectorAll(s));

      // Header mobil
      const burger = $('#chef-burger');
      const mobile = $('#chef-mobile');
      const closeBtn = $('#chef-close');
      const yearEl = $('#chef-year');
      if(yearEl) yearEl.textContent = new Date().getFullYear();
      if(burger && mobile && closeBtn){
        if(mobile.dataset.bound==='1') return; mobile.dataset.bound='1';
        const open = ()=> mobile.classList.add('active');
        const close = ()=> mobile.classList.remove('active');
        burger.addEventListener('click', open); closeBtn.addEventListener('click', close);
        mobile.addEventListener('click', e=>{ if(e.target===mobile) close(); });
        document.addEventListener('keydown', e=>{ if(e.key==='Escape') close(); });
        mobile.querySelectorAll('a').forEach(a=> a.addEventListener('click', close));
      }

      // ====== Date demo / persistenta ======
      const chefKey = 'BP_CHEF_PROFILE';
      const reqKey = 'BP_CLIENT_REQUESTS'; // aceleași cereri ca în dashboard client
      const chatKey = id => 'BP_CHAT_'+id; // chat comun per cerere (client & chef)

      // Seed dacă nu există profil chef
      let chef = null; let reqs = [];
      try{ chef = JSON.parse(localStorage.getItem(chefKey)); }catch(e){}
      try{ reqs = JSON.parse(localStorage.getItem(reqKey))||[]; }catch(e){ reqs=[] }
      if(!chef){
        chef = { name:'Chef Valeriu', email:'chef.valeriu@exemplu.ro', phone:'+40772893476', city:'București', avatar:'https://images.unsplash.com/photo-1500648767791-00dcc994a43e?q=80&w=400&auto=format&fit=crop', iban:'RO49AAAA1B31007593840000', status:'Disponibil' };
        localStorage.setItem(chefKey, JSON.stringify(chef));
      }

      // Populate profil
      $('#chef-name').textContent = chef.name;
      $('#chef-email').textContent = chef.email;
      $('#chef-phone').textContent = chef.phone;
      $('#chef-city').textContent = chef.city;
      $('#chef-avatar').src = chef.avatar;
      $('#chef-iban').textContent = chef.iban || '—';
      $('#chef-status').textContent = chef.status || '—';

      // Filtrăm doar cererile alocate sau toate (demo: toate + marcăm una alocată)
      reqs = reqs.map(r => ({...r, chef: r.chef || { name: chef.name, phone: chef.phone, avatar: chef.avatar }}));

      // Render cereri
      const list = $('#chef-req-list');
      function renderReqs(){
        list.innerHTML='';
        reqs.forEach(r=>{
          const el = document.createElement('div'); el.className='req'; el.dataset.id=r.id;
          const st = r.status?.toLowerCase().includes('nou') ? 'new' : (r.status?.toLowerCase().includes('discu')?'talk':'ok');
          el.innerHTML = `
            <div class="top">
              <div style="display:flex;align-items:center;gap:10px">
                <strong>#${r.id}</strong>
                <span class="status ${st}">${r.status||'—'}</span>
              </div>
              <div style="display:flex;gap:8px;align-items:center">
                <span><i class="fa-solid fa-user"></i> ${ (r.persons||'—') } pers</span>
                <span><i class="fa-solid fa-location-dot"></i> ${ r.city||'—' }</span>
                <span><i class="fa-solid fa-calendar"></i> ${ r.date||'—' }</span>
                <span><i class="fa-solid fa-coins"></i> ${ (r.budget||0).toLocaleString('ro-RO') } lei</span>
              </div>
            </div>
            <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px">
              <div>
                <div style="display:flex;align-items:center;gap:8px"><img src="https://images.unsplash.com/photo-1544005313-94ddf0286df2?q=80&w=200&auto=format&fit=crop" alt="Client" style="width:26px;height:26px;border-radius:50%"> <strong>${ r.client?.name || 'Client' }</strong></div>
              </div>
              <div style="display:flex;gap:8px">
                <button class="btn btn-ghost chef-open-chat"><i class="fa-solid fa-message"></i> Chat</button>
                <button class="btn chef-open-view"><i class="fa-solid fa-eye"></i> Detalii</button>
              </div>
            </div>`;
          list.appendChild(el);
        });
      }
      // Dacă nu există client.name pe cereri, adăugăm demo
      reqs = reqs.map(r=> ({...r, client: r.client || { name:'Client Nou', phone:'+40772893476' }}));
      renderReqs();

      // Chat
      let currentId = null; let currentClient = null;
      const chatWrap = $('#chef-chat'); const input = $('#chef-input'); const sendBtn = $('#chef-send');
      const clientNameEl = $('#chef-chat-client-name'); const metaEl = $('#chef-chat-req-meta'); const waBtn = $('#chef-chat-wa');
      const videoBtn = $('#chef-video');

      function renderChat(id){
        const r = reqs.find(x=>x.id===id); if(!r) return;
        currentId = id; currentClient = r.client;
        const data = JSON.parse(localStorage.getItem(chatKey(id))||'[]');
        chatWrap.innerHTML='';
        data.forEach(m=>{
          const d = document.createElement('div'); d.className='msg'+(m.me? '':' me'); // la chef inversăm sensul: me=false este client
          // Afișăm coerent: când e me=true în stocare = client (din pag. client). Marcăm pe UI bucătar la dreapta.
          const who = m.me ? 'Client' : 'Chef';
          d.innerHTML = `<div>${m.txt}</div><div class="meta">${who} · ${new Date(m.at).toLocaleString('ro-RO')}</div>`;
          chatWrap.appendChild(d);
        });
        chatWrap.scrollTop = chatWrap.scrollHeight;
        input.disabled = false; sendBtn.disabled = false; videoBtn.disabled = false;
        clientNameEl.textContent = r.client? r.client.name : 'Client';
        metaEl.textContent = `Cerere #${r.id} · ${r.date} · ${r.city} · ${r.persons} pers`;
        $('#chef-chat-client-avatar').src = 'https://images.unsplash.com/photo-1544005313-94ddf0286df2?q=80&w=200&auto=format&fit=crop';
        waBtn.href = r.client? `https://wa.me/${(r.client.phone||'').replace(/[^0-9]/g,'')}` : '#';
        videoBtn.dataset.room = `bucatarulpersonal-${r.id}`; // aceeași cameră ca în dashboard client
      }

      function pushMsg(id, fromChef, txt){
        // Stocăm din perspectiva clientului: me=true înseamnă client. Aici inversăm.
        const k = chatKey(id); const arr = JSON.parse(localStorage.getItem(k)||'[]');
        arr.push({me: !fromChef, txt, at: Date.now()});
        localStorage.setItem(k, JSON.stringify(arr));
      }

      list.addEventListener('click', e=>{
        const btn = e.target.closest('.chef-open-chat');
        const view = e.target.closest('.chef-open-view');
        const card = e.target.closest('.req');
        if(!card) return; const id = card.dataset.id;
        if(btn){ renderChat(id); }
        if(view){ openDialog('Detalii cerere #'+id, 'view', id); }
      });

      sendBtn.addEventListener('click', ()=>{
        const txt = (input.value||'').trim(); if(!txt || !currentId) return; pushMsg(currentId, true, txt); input.value=''; renderChat(currentId);
        if(currentClient){ setTimeout(()=>{ pushMsg(currentId, false, 'Mulțumesc! Confirm primirea mesajului.'); renderChat(currentId); }, 800); }
      });
      input.addEventListener('keydown', e=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendBtn.click(); }});

      // Export chat
      $('#chef-export').addEventListener('click', ()=>{
        if(!currentId){ alert('Selectează o cerere.'); return; }
        const k = chatKey(currentId); const arr = JSON.parse(localStorage.getItem(k)||'[]');
        let txt = `Conversație cerere ${currentId} (Chef)\n`;
        arr.forEach(m=>{ txt += `[${new Date(m.at).toLocaleString('ro-RO')}] ${m.me?'Client':'Chef'}: ${m.txt}\n`; });
        const blob = new Blob([txt], {type:'text/plain'});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `chat_${currentId}_chef.txt`; a.click(); URL.revokeObjectURL(a.href);
      });

      // === VideoCall (Jitsi iFrame API) ===
      const vModal = $('#chef-vmodal'); const vClose = $('#chef-vclose'); const vCopy = $('#chef-vcopy'); const vTitle = $('#chef-vtitle');
      let jitsiApi = null; let jitsiLoaded = false;
      function loadJitsi(cb){
        if(jitsiLoaded){ cb(); return; }
        const s = document.createElement('script'); s.src = 'https://meet.jit.si/external_api.js';
        s.onload = ()=>{ jitsiLoaded = true; cb(); };
        s.onerror = ()=>{ alert('Nu am putut încărca componenta de videoconferință.'); };
        document.head.appendChild(s);
      }
      function openVideo(room){
        loadJitsi(()=>{
          vModal.classList.add('active');
          $('#chef-jitsi').innerHTML = '';
          const domain = 'meet.jit.si';
          const options = {
            roomName: room,
            parentNode: document.getElementById('chef-jitsi'),
            width: '100%', height: '100%',
            userInfo: { displayName: chef.name||'Chef' },
            configOverwrite: { prejoinPageEnabled: true },
            interfaceConfigOverwrite: { DEFAULT_REMOTE_DISPLAY_NAME: 'Invitat', SHOW_CHROME_EXTENSION_BANNER: false }
          };
          jitsiApi = new JitsiMeetExternalAPI(domain, options);
          vTitle.textContent = `Camera pentru ${clientNameEl.textContent} · ${metaEl.textContent}`;
        });
      }
      function closeVideo(){ if(jitsiApi){ jitsiApi.dispose(); jitsiApi = null; } vModal.classList.remove('active'); }
      vClose.addEventListener('click', closeVideo);

      const videoBtn = $('#chef-video');
      videoBtn.addEventListener('click', ()=>{
        if(videoBtn.disabled || !currentId) return;
        const room = videoBtn.dataset.room || ('bucatarulpersonal-'+currentId);
        openVideo(room);
      });
      vCopy.addEventListener('click', ()=>{
        const room = videoBtn.dataset.room || 'bucatarulpersonal';
        const link = `https://meet.jit.si/${room}`;
        navigator.clipboard.writeText(link).then(()=>{ vCopy.innerHTML = '<i class="fa-solid fa-check"></i> Copiat'; setTimeout(()=>{ vCopy.innerHTML = '<i class="fa-solid fa-link"></i> Copiază link'; }, 1400); });
      });

      // Dialogs (edit profil / view cerere)
      const dialog = $('#chef-dialog'); const dlgTitle = $('#chef-dialog-title'); const dlgX = $('#chef-dialog-x');
      const secProfile = $('#chef-form-profile'); const secView = $('#chef-form-view'); const hint = $('#chef-form-hint');
      function openDialog(title, mode, id){
        dlgTitle.textContent = title; dialog.classList.add('active');
        if(mode==='profile'){
          secProfile.style.display='block'; secView.style.display='none';
          $('#c-name').value = chef.name||''; $('#c-city').value = chef.city||''; $('#c-email').value = chef.email||''; $('#c-phone').value = chef.phone||''; $('#c-iban').value = chef.iban||''; $('#c-avatar').value = chef.avatar||'';
          hint.innerHTML = '<i class="fa-solid fa-user"></i> Actualizează datele profilului';
          $('#chef-save').onclick = ()=>{
            chef.name = $('#c-name').value.trim(); chef.city=$('#c-city').value.trim(); chef.email=$('#c-email').value.trim(); chef.phone=$('#c-phone').value.trim(); chef.iban=$('#c-iban').value.trim(); chef.avatar=$('#c-avatar').value.trim()||chef.avatar;
            localStorage.setItem(chefKey, JSON.stringify(chef));
            $('#chef-name').textContent = chef.name; $('#chef-city').textContent = chef.city; $('#chef-email').textContent = chef.email; $('#chef-phone').textContent = chef.phone; $('#chef-iban').textContent = chef.iban; $('#chef-avatar').src = chef.avatar;
            closeDialog();
          };
        }
        if(mode==='view' && id){
          secProfile.style.display='none'; secView.style.display='block';
          const r = reqs.find(x=>x.id===id); if(!r) return;
          $('#v-id').value = r.id; $('#v-date').value = r.date; $('#v-city').value = r.city; $('#v-persons').value = r.persons; $('#v-budget').value = (r.budget||0).toLocaleString('ro-RO')+' lei'; $('#v-client').value = r.client?.name || 'Client'; $('#v-notes').value = r.notes||'';
          hint.innerHTML = '<i class="fa-solid fa-eye"></i> Detalii cerere';
          $('#chef-save').onclick = ()=>{ closeDialog(); };
        }
      }
      function closeDialog(){ dialog.classList.remove('active'); }
      $('#chef-edit').addEventListener('click', ()=> openDialog('Editează profil', 'profile'));
      dlgX.addEventListener('click', closeDialog);
      dialog.addEventListener('click', e=>{ if(e.target===dialog) closeDialog(); });

      // Selectează primul chat disponibil
      if(reqs[0]){ renderChat(reqs[0].id); }

      // --- Mini teste ---
      function assert(c,m){ if(!c) throw new Error('TEST FAIL: '+m); console.log('TEST OK:', m); }
      try{
        assert($('#chef-name').textContent.length>0, 'profil chef încărcat');
        assert($$('#chef-req-list .req').length>=1, 'lista cereri randată');
        console.log('[CHEF] All tests passed ✅');
      }catch(e){ console.error(e); }
    })();
  </script>
</body>
</html>
